<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* === ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ === */
        body {
            font-family: 'Inter', sans-serif;
            /* èƒŒæ™¯è‰²ã¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ */
            background: linear-gradient(135deg, #e0f7fa 0%, #f9f0ff 100%);
            /* ğŸ”½ ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ¿ƒã„è‰² (#1f2937) ã«æˆ»ã—ã€å„è¦ç´ ã§ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’å†èª¿æ•´ */
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            /* ğŸ”½ ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºãŒä¸»ï¼‰ */
            font-size: 0.95rem;
        }
        
        /* ğŸ”½ ä¿®æ­£: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§æ¨™æº–ã‚µã‚¤ã‚ºã«æˆ»ã™ */
        @media (min-width: 768px) {
            body {
                font-size: 1rem;
            }
        }
        
        /* ğŸ”½ ä¿®æ­£: ã‚«ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã‚’æ˜ç¤ºçš„ã«ç™½ï¼ˆã¾ãŸã¯éå¸¸ã«æ˜ã‚‹ã„è‰²ï¼‰ã«è¨­å®š */
        .bg-white { background-color: #ffffff !important; }
        
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important; }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰) */
        .reservation-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* ç´«ç³»ã®ã‚µãƒ ãƒã‚¤ãƒ« */
            border-radius: 10px;
        }
        .reservation-list::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        /* ğŸ”½ ä¿®æ­£: input/select ã®ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ˜ç¢ºã«é»’ç³»çµ±ã«è¨­å®š (èƒŒæ™¯è‰²æŒ‡å®šã‚’å‰Šé™¤) */
        input:not(.dark *), select:not(.dark *) {
             color: #1f2937; /* æ¿ƒã„æ–‡å­—è‰²ã‚’ç¶­æŒ */
             /* èƒŒæ™¯è‰²ã¯HTMLã®bg-whiteã‚¯ãƒ©ã‚¹ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ */
        }

        /* ğŸ”½ 1. çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’é»’ã«å›ºå®š */
        /* ã‚«ãƒ¼ãƒ‰ã®æ•°å­— (text-2xl font-bold text-gray-900) ã«å½“ãŸã‚‹è¦ç´ ã®ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®è‰²ã‚’é»’ã«å›ºå®š */
        .bg-white p.text-2xl.font-bold.text-gray-900 {
            color: #1f2937 !important;
        }

        /* ğŸ”½ 2. äºˆç´„ãƒªã‚¹ãƒˆå†…ã®æƒ…å ±ï¼ˆåå‰ä»¥å¤–ï¼‰ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã«å›ºå®š */
        /* text-gray-600 ã®è‰²ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã« (text-gray-700ç›¸å½“) */
        .bg-white .text-gray-600 {
            color: #374151 !important; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        }
        /* ğŸ”½ äºˆç´„ãƒªã‚¹ãƒˆå†…ã®æƒ…å ±ï¼ˆspanã‚¿ã‚°ã§å¼·èª¿ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ï¼‰ã‚’é»’ã«å›ºå®š */
        .bg-white .text-gray-900 {
            color: #1f2937 !important; /* é»’ã«è¿‘ã„è‰² */
        }
        
        /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        .dark body {
            background: #1f2937; /* æš—ã„èƒŒæ™¯ */
            color: #f3f4f6; /* æ˜ã‚‹ã„ãƒ†ã‚­ã‚¹ãƒˆ */
        }
        
        /* ğŸŒŸ è¿½åŠ : ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã«æœ¬æ–‡ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
        body.overflow-hidden {
            overflow: hidden;
        }

        /* ğŸ”½ ã“ã“ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚«ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã§ã™ (æ¿ƒã„ã‚°ãƒ¬ãƒ¼) */
        .dark .bg-white {
            background-color: #374151 !important; /* æš—ã‚ã®ã‚°ãƒ¬ãƒ¼ */
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
        .dark .shadow-2xl { 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important; 
        }
        
        /* ğŸ”½ ã‚µãƒãƒªãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰²ã‚’fuchsia-600ã«çµ±ä¸€ (JSã§ç›´æ¥ã‚¯ãƒ©ã‚¹ã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦ã ãŒå¿µã®ãŸã‚æ®‹ã™) */
        /* ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’fuchsia-600/text-whiteã«ä¿®æ­£ */
        .group-header {
            background-color: #ec4899; /* fuchsia-600 */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .dark .group-header {
            background-color: #db2777; /* fuchsia-700 or fuchsia-600 on dark */
            color: #f3f4f6;
        }
        
        /* ğŸ”½ ä»¥å‰ã®ä¸Šæ›¸ãã‚’å‰Šé™¤ã—ã€JSå´ã®ã‚¯ãƒ©ã‚¹ä¿®æ­£ã«ä»»ã›ã‚‹ */
        .dark .text-fuchsia-700 { color: #f0abfc !important; } 
        .dark .border-fuchsia-400 { border-color: #a78bfa !important; }


        /* ğŸ”½ ã“ã“ã§ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç™½è‰²ç³»çµ±ã«ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ */
        .dark input, .dark select {
            background-color: #4b5563; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            color: #f3f4f6; /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
            border-color: #6b7280;
        }
        
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .text-gray-900 { color: #f3f4f6 !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-800 { color: #f3f4f6 !important; } /* ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã¨äºˆç´„ãƒªã‚¹ãƒˆã®H2ã‚¿ã‚°ãªã©ã«å¯¾å¿œ */
        .dark .text-gray-700 { color: #e5e7eb !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-600 { color: #d1d5db !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-500 { color: #9ca3af !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark p.text-2xl.font-bold.text-gray-900 { color: #f3f4f6 !important; } /* çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®æ•°å­— */


        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        .dark .reservation-list::-webkit-scrollbar-thumb {
            background-color: #8b5cf6; 
        }
        .dark .reservation-list::-webkit-scrollbar-track {
            background: #4b5563;
        }

        .reservation-list {
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã€æœ€å¤§é«˜ã•ã‚’è¨­å®š */
            min-height: 70vh;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  */
        .reservation-list::-webkit-scrollbar {
            width: 8px;
        }
        .reservation-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* ç´«ç³»ã®ã‚µãƒ ãƒã‚¤ãƒ« */
            border-radius: 10px;
        }
        .reservation-list::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        /* ç”»åƒã‚’ã‚«ãƒ¼ãƒ‰ã«åã‚ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .figure-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0; /* ç”»åƒãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰ (ğŸŒŸ è¿½åŠ ) */
        @keyframes pulse-once {
          0% { background-color: #8b5cf6; }
          50% { background-color: #a78bfa; }
          100% { background-color: #8b5cf6; }
        }
        .animate-pulse-once {
            animation: pulse-once 2s ease-out;
        }

        /* ğŸ”½ æ–°è¦è¿½åŠ : å³ä¸‹å›ºå®šã®ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .fixed-menu-button {
            position: fixed;
            bottom: 20px; /* ä¸‹ã‹ã‚‰ã®è·é›¢ */
            right: 20px; /* å³ã‹ã‚‰ã®è·é›¢ */
            z-index: 51; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šæ‰‹å‰ */
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-7xl mx-auto">
        <div class="mb-10 p-6 md:p-8 bg-white dark:bg-gray-800 rounded-3xl shadow-2xl border border-fuchsia-200 dark:border-fuchsia-900 relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 dark:opacity-20 pointer-events-none" style="background-image: radial-gradient(#ec4899 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div class="absolute w-60 h-60 bg-fuchsia-300/50 dark:bg-fuchsia-700/50 rounded-full blur-3xl -top-10 -left-10 z-0"></div>
            
            <div class="flex justify-between items-center relative z-10">
                <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 dark:text-white flex items-center">
                    <i data-lucide="sparkles" class="w-9 h-9 md:w-12 md:h-12 mr-4 text-fuchsia-600 dark:text-fuchsia-400 transform rotate-12"></i>
                    ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
                </h1>
                <button id="toggle-dark-mode" class="p-3 md:p-4 rounded-full bg-fuchsia-100 text-gray-700 hover:text-fuchsia-900 hover:bg-fuchsia-200 dark:bg-fuchsia-900 dark:text-gray-300 dark:hover:text-white dark:hover:bg-fuchsia-700 transition duration-300 transform hover:scale-110 shadow-lg">
                    <i data-lucide="moon" class="w-6 h-6"></i>
                </button>
            </div>
            
            <p class="mt-2 text-md md:text-lg text-gray-600 dark:text-gray-400 relative z-10">
                ã‚ãªãŸã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒãƒ¼ãƒˆã«ã€ãã—ã¦ç¾ã—ãç®¡ç†ã—ã¾ã—ã‚‡ã†ã€‚
            </p>
        </div>
        <div class="mb-8">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-reservations" data-tab="reservations" class="tab-button py-3 px-4 font-medium text-lg whitespace-nowrap transition duration-200 rounded-lg bg-fuchsia-600 text-white shadow-md dark:bg-fuchsia-700 dark:text-white">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-2 inline-block"></i>
                        äºˆç´„ãƒªã‚¹ãƒˆ
                    </button>
                    <button id="tab-owned" data-tab="owned" class="tab-button py-3 px-4 font-medium text-lg whitespace-nowrap transition duration-200 rounded-lg text-gray-500 hover:text-fuchsia-600 hover:bg-fuchsia-50 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                        <i data-lucide="archive" class="w-5 h-5 mr-2 inline-block"></i>
                        æ‰€æŒãƒªã‚¹ãƒˆ
                    </button>
                </nav>
            </div>
        </div>
        <div id="auth-info-firebase" class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-xl shadow-lg text-sm text-yellow-800 font-semibold flex items-center">
            <i data-lucide="cloud-off" class="w-5 h-5 mr-3 inline-block"></i>
            ã€æœªæ¥ç¶šã€‘`firebaseConfig`ã‚’è¨­å®šã—ã¦ã€Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚
        </div>

        <div id="stats" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            </div>

        <div id="tab-content-container">

            <div id="page-reservations" class="tab-page">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <button id="open-modal-btn" class="w-full md:w-auto px-8 py-3 bg-fuchsia-600 text-white font-bold rounded-full shadow-xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                        æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ 
                    </button>
                    <div class="flex items-center space-x-3">
                        <label for="group-by-select" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">ç™ºå£²æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>

                <div id="main-content-wrapper-reservations" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 md:col-span-3 md:h-fit md:sticky md:top-4 md:p-6 md:rounded-3xl md:shadow-2xl md:border md:border-gray-100 p-6 rounded-r-3xl shadow-2xl border-r border-t border-b border-gray-200 overflow-y-auto">
                        <button id="close-summary-btn-reservations" class="md:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-900 p-2 rounded-full hover:bg-gray-100 transition z-50">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <h2 id="summary-title-reservations" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-3 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                äºˆç´„ãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="reservation-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>ä¸Šã®ã€Œæ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar-overlay-reservations" class="hidden md:hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-40 transition-opacity duration-300"></div>
            </div>
            
            <div id="page-owned" class="tab-page hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <div class="flex-grow"></div> 
                    <div class="flex items-center space-x-3">
                        <label for="group-by-select-owned" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select-owned" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">è³¼å…¥/å—å–æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>
                <div id="main-content-wrapper-owned" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar-owned" class="fixed inset-y-0 left-0 w-80 bg-white z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 md:col-span-3 md:h-fit md:sticky md:top-4 md:p-6 md:rounded-3xl md:shadow-2xl md:border md:border-gray-100 p-6 rounded-r-3xl shadow-2xl border-r border-t border-b border-gray-200 overflow-y-auto">
                        <button id="close-summary-btn-owned" class="md:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-900 p-2 rounded-full hover:bg-gray-100 transition z-50">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <h2 id="summary-title-owned" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list-owned" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-3 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="archive" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                æ‰€æŒãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator-owned" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="owned-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-owned-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€å—ã‘å–ã‚Šæ¸ˆã¿ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>äºˆç´„ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†ã€ã«æ›´æ–°ã—ã¦ãã ã•ã„ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar-overlay-owned" class="hidden md:hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-40 transition-opacity duration-300"></div>
            </div>

        </div>
        </div>

    <div id="mobile-fixed-menu" class="fixed-menu-button md:hidden">
        <button id="fixed-summary-btn-reservations" 
            class="p-3 bg-fuchsia-600 text-white rounded-full shadow-2xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105" 
            aria-label="ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’é–‹ã (äºˆç´„)">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <button id="fixed-summary-btn-owned" 
            class="p-3 bg-fuchsia-600 text-white rounded-full shadow-2xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105 hidden" 
            aria-label="ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’é–‹ã (æ‰€æŒ)">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </div>
    
    <div id="reservation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-8 relative transform transition-all duration-300">
            <h2 id="modal-title" class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ </h2>
            
            <form id="reservation-form" class="space-y-5">
                <input type="hidden" id="doc-id">

                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å <span class="text-red-500">*</span></label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>
                
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700">ç”»åƒURL</label>
                    <input type="url" id="imageUrl" placeholder="http://..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="manufacturer" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ã‚«ãƒ¼å/ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
                        <input type="text" id="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="scale" class="block text-sm font-medium text-gray-700">ã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ± (ä¾‹: 1/7, HG)</label>
                        <input type="text" id="scale" placeholder="ä¾‹: 1/7" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="reservationDate" class="block text-sm font-medium text-gray-700">äºˆç´„æ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="reservationDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                    <div>
                        <label for="releaseDate" class="block text-sm font-medium text-gray-700">ç™ºå£²/å¼•æ¸¡äºˆå®šæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="releaseDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="shop" class="block text-sm font-medium text-gray-700">è³¼å…¥åº—èˆ—/äºˆç´„ã‚µã‚¤ãƒˆ</label>
                        <input type="text" id="shop" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">ä¾¡æ ¼ (å††)</label>
                        <input type="number" id="price" min="0" value="0" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">äºˆç´„çŠ¶æ³ <span class="text-red-500">*</span></label>
                    <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150 bg-white">
                        <option value="äºˆç´„æ¸ˆã¿">äºˆç´„æ¸ˆã¿</option>
                        <option value="æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰">æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰</option>
                        <option value="ç™ºé€é€£çµ¡å¾…ã¡">ç™ºé€é€£çµ¡å¾…ã¡</option>
                        <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        <option value="å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†">å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="orderNumber" class="block text-sm font-medium text-gray-700">æ³¨æ–‡ç•ªå·/äºˆç´„ç•ªå·</label>
                        <input type="text" id="orderNumber" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">å‚™è€ƒæ¬„</label>
                        <input type="text" id="notes" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="close-modal-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-8 py-2 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-105">ä¿å­˜</button>
                </div>
            </form>
            <button id="modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold text-red-600 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                å‰Šé™¤ã®ç¢ºèª
            </h3>
            <p class="text-gray-700">æœ¬å½“ã«ã“ã®äºˆç´„æƒ…å ±ï¼ˆ<span id="delete-item-name" class="font-bold"></span>ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="confirm-delete-btn" class="px-8 py-2 bg-red-600 text-white font-bold rounded-full shadow-md hover:bg-red-700 transition duration-150">å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰
        setLogLevel('Debug');
        
        // =========================================================
        // ğŸš¨ ã€é‡è¦ã€‘ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // (æ·»ä»˜ã‚³ãƒ¼ãƒ‰ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™)
        // =========================================================
    	const firebaseConfig = {
  		apiKey: "AIzaSyD9jmIafM4JjpJyv65WjFWlbV_n9dssUt4",
  		authDomain: "figure-manager-app.firebaseapp.com",
  		projectId: "figure-manager-app",
  		storageBucket: "figure-manager-app.firebaseapp.com",
  		messagingSenderId: "487492839040",
  		appId: "1:487492839040:web:a43419d861335f259da865",
  		measurementId: "G-19FTK3XTW4"
	};
        // =========================================================
        // ğŸš¨ ã“ã“ã‹ã‚‰ä¸‹ã¯ç·¨é›†ã—ãªã„ã§ãã ã•ã„
        // =========================================================

        let db, auth;
        let reservations = [];
        const COLLECTION_NAME = 'figure_reservations_data'; 

        // DOMè¦ç´ ã®å–å¾—
        const reservationListEl = document.getElementById('reservation-list');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');
        const modal = document.getElementById('reservation-modal');
        const form = document.getElementById('reservation-form');
        const modalTitle = document.getElementById('modal-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');
        const statsEl = document.getElementById('stats');
        const authInfoEl = document.getElementById('auth-info-firebase');
        const groupBySelect = document.getElementById('group-by-select'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿
        const groupSummaryListEl = document.getElementById('group-summary-list'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼è¦ç´ 
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteItemNameEl = document.getElementById('delete-item-name');
        let docIdToDelete = null;

        // ğŸŒŸ æ–°è¦è¿½åŠ ã•ã‚ŒãŸDOMè¦ç´ ã¨çŠ¶æ…‹å¤‰æ•°
        const tabReservationsBtn = document.getElementById('tab-reservations');
        const tabOwnedBtn = document.getElementById('tab-owned');
        const pageReservationsEl = document.getElementById('page-reservations');
        const pageOwnedEl = document.getElementById('page-owned');
        const ownedListEl = document.getElementById('owned-list');
        const groupSummaryListOwnedEl = document.getElementById('group-summary-list-owned');
        const noOwnedDataMessage = document.getElementById('no-owned-data-message');
        const loadingIndicatorOwned = document.getElementById('loading-indicator-owned');
        
        // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚·ãƒ¼ãƒˆç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã‚’è¿½åŠ 
        const groupBySelectOwned = document.getElementById('group-by-select-owned');
        
        // ğŸ”½ æ–°è¦è¿½åŠ : ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ 
        const summaryTitleReservationsEl = document.getElementById('summary-title-reservations');
        const summaryTitleOwnedEl = document.getElementById('summary-title-owned');
        
        // ğŸŒŸ æ–°è¦è¿½åŠ : ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£ã®DOMè¦ç´ 
        const groupSummarySidebarReservations = document.getElementById('group-summary-sidebar');
        // ğŸ”½ å¤‰æ›´: å›ºå®šãƒœã‚¿ãƒ³ã®DOMè¦ç´ ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
        const openSummaryBtnReservations = document.getElementById('fixed-summary-btn-reservations');
        const closeSummaryBtnReservations = document.getElementById('close-summary-btn-reservations');
        const sidebarOverlayReservations = document.getElementById('sidebar-overlay-reservations');
        
        const groupSummarySidebarOwned = document.getElementById('group-summary-sidebar-owned');
        // ğŸ”½ å¤‰æ›´: å›ºå®šãƒœã‚¿ãƒ³ã®DOMè¦ç´ ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
        const openSummaryBtnOwned = document.getElementById('fixed-summary-btn-owned');
        const closeSummaryBtnOwned = document.getElementById('close-summary-btn-owned');
        const sidebarOverlayOwned = document.getElementById('sidebar-overlay-owned');

        // ğŸ”½ è¿½åŠ : å›ºå®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã‚’å–å¾—
        const mobileFixedMenu = document.getElementById('mobile-fixed-menu');
        let currentView = 'reservations'; // 'reservations' or 'owned'

        // äºˆç´„çŠ¶æ³ã®ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
        const STATUS_COLORS = {
            'äºˆç´„æ¸ˆã¿': 'bg-blue-200 text-blue-800 border-blue-300',
            'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰': 'bg-amber-200 text-amber-800 border-amber-300',
            'ç™ºé€é€£çµ¡å¾…ã¡': 'bg-purple-200 text-purple-800 border-purple-300',
            'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 'bg-gray-200 text-gray-500 border-gray-300',
            'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†': 'bg-green-200 text-green-800 border-green-300'
        };
        const STATUS_COMPLETED = 'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†';
        const STATUS_CANCELLED = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';

        // ğŸŒŸ å¤‰æ›´ãªã—: ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚¯ãƒ©ã‚¹
        // èƒŒæ™¯è‰²ã€æ–‡å­—è‰²ã€ã‚·ãƒ£ãƒ‰ã‚¦ãªã©ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã«é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹
        const ACTIVE_CLASSES = ['bg-fuchsia-600', 'text-white', 'shadow-md', 'dark:bg-fuchsia-700', 'dark:text-white'];
        // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã«é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹
        const INACTIVE_CLASSES = ['text-gray-500', 'hover:text-fuchsia-600', 'hover:bg-fuchsia-50', 'dark:text-gray-400', 'dark:hover:bg-gray-700', 'dark:hover:text-white'];


        /**
         * ä¾¡æ ¼ã‚’æ—¥æœ¬å††ã®å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         * @param {number} price
         * @returns {string}
         */
        const formatCurrency = (price) => {
            if (typeof price !== 'number' || isNaN(price)) {
                return 'N/A';
            }
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(price);
        };

        /**
         * çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
         * @param {string} title - ã‚¿ã‚¤ãƒˆãƒ«
         * @param {string | number} value - è¡¨ç¤ºå€¤
         * @returns {string} - HTMLæ–‡å­—åˆ—
         */
        const createStatCard = (title, value) => {
            // ğŸ”½ ä¿®æ­£: text-fuchsia-600 ã‚’è¿½åŠ ã—ã¦ã€ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’çµ±ä¸€
            let icon = 'tag'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
            let iconClass = 'text-fuchsia-600';

            if (title.includes('ç·ä»¶æ•°')) {
                icon = 'layers';
            } else if (title.includes('æœªå®Œäº†')) {
                icon = 'alert-triangle';
            } else if (title.includes('ç·é¡')) {
                icon = 'yen-sign';
            } else if (title.includes('ä»Šæœˆ')) {
                icon = 'calendar-clock';
            } else if (title.includes('å¹´é–“')) {
                icon = 'sparkles';
            }
            
            // ğŸ”½ ä¿®æ­£: p-5 ã‚’ p-6 ã«å¤‰æ›´ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´
            return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 dark:bg-gray-800 dark:border-gray-700 transform hover:scale-[1.01] transition duration-300">
                <div class="flex items-center space-x-3">
                    <i data-lucide="${icon}" class="w-6 h-6 ${iconClass}"></i>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${title}</p>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1 text-left">${value}</p>
            </div>
            `;
        };

        /**
         * ğŸŒŸ çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ (äºˆç´„ã¨æ‰€æŒãƒ“ãƒ¥ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆã‚‹)
         */
        const updateStats = (view) => {
            const thisYear = new Date().getFullYear();
            const thisMonth = new Date().getMonth(); // 0-11
            
            if (view === 'reservations') {
                // --- äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æœªå®Œäº†ã®ã¿) ---
                const pendingReservationsData = reservations.filter(r => r.status !== STATUS_COMPLETED && r.status !== STATUS_CANCELLED);

                let totalReserved = 0; // æ”¯æ‰•ã„äºˆå®šç·é¡
                let upcomingPaymentTotal = 0; // ä»Šæœˆãƒ»æ¥æœˆæ”¯æ‰•äºˆå®šé¡
                let pendingReservations = 0; // æœªå®Œäº†ã®äºˆç´„ä»¶æ•° (äºˆç´„/æ”¯æ‰•ã„æ¸ˆã¿/ç™ºé€å¾…ã¡)

                pendingReservationsData.forEach(r => {
                    const price = r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null;
                    const status = r.status;

                    // æ”¯æ‰•ã„äºˆå®šç·é¡ã®è¨ˆç®— (å—ã‘å–ã‚Šæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–)
                    totalReserved += price;

                    // ä»Šæœˆãƒ»æ¥æœˆç™ºå£²äºˆå®šã®æ”¯æ‰•ã„åˆè¨ˆ
                    if (releaseDate) {
                        const releaseMonth = releaseDate.getMonth();
                        const releaseYear = releaseDate.getFullYear();

                        const nextMonthDate = new Date();
                        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                        const nextMonth = nextMonthDate.getMonth();
                        const nextMonthYear = nextMonthDate.getFullYear();

                        const isThisMonth = releaseYear === thisYear && releaseMonth === thisMonth;
                        const isNextMonth = releaseYear === nextMonthYear && releaseMonth === nextMonth;

                        if (isThisMonth || isNextMonth) {
                            upcomingPaymentTotal += price;
                        }
                    }

                    // æœªå®Œäº†ã®äºˆç´„ä»¶æ•°
                    if (status === 'äºˆç´„æ¸ˆã¿' || status === 'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰' || status === 'ç™ºé€é€£çµ¡å¾…ã¡') {
                        pendingReservations++;
                    }
                });
                
                const totalReservations = reservations.length;

                // ğŸ”½ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨ colorClass ã®å¼•æ•°ã‚’å‰Šé™¤
                statsEl.innerHTML = `
                    ${createStatCard('äºˆç´„ç·ä»¶æ•° (å…¨ãƒ‡ãƒ¼ã‚¿)', totalReservations)}
                    ${createStatCard('æœªå®Œäº†ä»¶æ•°', pendingReservations)}
                    ${createStatCard('æ”¯æ‰•ã„äºˆå®šç·é¡', formatCurrency(totalReserved))}
                    ${createStatCard('ä»Šæœˆãƒ»æ¥æœˆæ”¯æ‰•äºˆå®šé¡', formatCurrency(upcomingPaymentTotal))}
                `;

            } else if (view === 'owned') {
                // --- æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æ–°è¦ãƒ­ã‚¸ãƒƒã‚¯) ---
                const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);

                let totalOwnedPrice = 0;
                let thisYearOwnedCount = 0;

                ownedReservations.forEach(r => {
                    totalOwnedPrice += r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null; // releaseDateã‚’ã“ã“ã§ã¯ã€Œå–å¾—æ—¥ã€ã¨è¦‹ãªã™

                    if (releaseDate && releaseDate.getFullYear() === thisYear) {
                        thisYearOwnedCount++;
                    }
                });

                statsEl.innerHTML = `
                    ${createStatCard('æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ç·ä»¶æ•°', ownedReservations.length)}
                    ${createStatCard('ä»Šå¹´å…¥æ‰‹ã—ãŸä»¶æ•°', thisYearOwnedCount)}
                    ${createStatCard('ç·æŠ•è³‡é¡', formatCurrency(totalOwnedPrice))}
                    ${createStatCard('å¹³å‡ä¾¡æ ¼', formatCurrency(ownedReservations.length > 0 ? totalOwnedPrice / ownedReservations.length : 0))}
                `;
            }
            lucide.createIcons(); // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        };
        
        /**
         * ğŸŒŸ ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
         */
        const updateSummaryTitle = (view, groupBy) => {
            const targetEl = view === 'reservations' ? summaryTitleReservationsEl : summaryTitleOwnedEl;
            const title = view === 'reservations' ? 'ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼' : 'æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ ã‚µãƒãƒªãƒ¼';
            const groupByText = document.querySelector(`#group-by-select${view === 'owned' ? '-owned' : ''} option[value="${groupBy}"]`).textContent;
            
            targetEl.innerHTML = `
                <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                ${title} (${groupByText})
            `;
        };


        /**
         * ğŸŒŸ ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’æç”»ã™ã‚‹é–¢æ•°
         * @param {Array<Object>} reservationsToRender - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®äºˆç´„ãƒ‡ãƒ¼ã‚¿é…åˆ—
         * @param {HTMLElement} listTargetEl - æç”»å¯¾è±¡ã®DOMè¦ç´  (ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ãƒªã‚¹ãƒˆ)
         * @param {string} groupBy - ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®åŸºæº–
         * @param {string} viewTitle - 'äºˆç´„' or 'æ‰€æŒ'
         */
        const renderGroupSummary = (reservationsToRender, listTargetEl, groupBy, viewTitle) => {
            listTargetEl.innerHTML = '';
            
            if (groupBy === 'none' || reservationsToRender.length === 0) {
                listTargetEl.innerHTML = `<p class="text-gray-500 text-sm">ç¾åœ¨ã€${groupBy === 'none' ? 'ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' : 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'}</p>`;
                return;
            }
            
            let groupedReservations = {};

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
            reservationsToRender.forEach(r => {
                let groupKey;
                
                if (groupBy === 'releaseDateMonth') {
                    const date = r.releaseDate;
                    groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                } else if (groupBy === 'manufacturer') {
                    groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼æœªå®š';
                } else if (groupBy === 'shop') {
                    groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—æœªå®š';
                } else if (groupBy === 'scale') {
                    groupKey = r.scale && r.scale.trim() !== '' ? 'ã‚¹ã‚±ãƒ¼ãƒ«ï¼š' + r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«æœªå®š';
                }

                if (!groupedReservations[groupKey]) {
                    groupedReservations[groupKey] = [];
                }
                groupedReservations[groupKey].push(r);
            });

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ã‚Šã®å ´åˆã¨åŒã˜ã§OK
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                // 'none'ã®å ´åˆã¯ã‚­ãƒ¼ãŒä¸€ã¤ãªã®ã§ã‚½ãƒ¼ãƒˆä¸è¦
                return a.localeCompare(b);
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ã‚Šã®å ´åˆ
            sortedGroupKeys.forEach((groupKey) => {
                const reservationsInGroup = groupedReservations[groupKey];
                const count = reservationsInGroup.length;
                let displayKey = groupKey;
                
                if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                    const [year, month] = groupKey.split(' ')[0].split('-');
                    displayKey = `${year}å¹´${month}æœˆ ${groupKey.split(' ')[1]}`;
                }
                
                if (groupBy === 'none') {
                    // ã‚­ãƒ¼ã¯ã€Œå…¨æœªå®Œäº†ã‚¢ã‚¤ãƒ†ãƒ ã€ã¾ãŸã¯ã€Œå…¨æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã€
                    displayKey = groupKey;
                }

                // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ
                const groupContainer = document.createElement('div');
                // ğŸ”½ ä¿®æ­£: ãƒœãƒ¼ãƒ€ãƒ¼ã®è‰²ã‚’fuchsia-600ã«
                groupContainer.className = 'group-summary-item border border-fuchsia-600 dark:border-fuchsia-400 rounded-xl shadow-sm hover:shadow-md transition duration-200';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼
                const header = document.createElement('div');
                // ğŸ”½ ä¿®æ­£1: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚bg-fuchsia-600/text-whiteã«ãªã‚‹ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹ã‚’ä¿®æ­£
                header.className = 'p-3 bg-fuchsia-600 font-bold text-white cursor-pointer flex justify-between items-center rounded-xl transition duration-150 hover:bg-fuchsia-700 dark:hover:bg-fuchsia-700';

                header.innerHTML = `
                    <span class="text-sm md:text-base truncate">${displayKey}</span>
                    <span class="bg-white/30 text-white font-extrabold px-2 py-0.5 rounded-full text-xs flex-shrink-0">${count}ä»¶</span>
                `;

                // ãƒªã‚¹ãƒˆï¼ˆæœ€åˆã¯éš ã™ï¼‰
                const figureList = document.createElement('div');
                figureList.className = 'p-3 space-y-2'; // å¸¸ã«é–‹ããŸã‚ hidden ã‚’å‰Šé™¤

                reservationsInGroup.forEach(r => {
                    const listItem = document.createElement('div');
                    listItem.className = 'text-sm text-gray-700 dark:text-gray-300 hover:text-fuchsia-700 dark:hover:text-fuchsia-300 transition duration-150 cursor-pointer truncate';
                    listItem.textContent = r.name;
                    listItem.dataset.id = r.id; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆIDã‚’ä¿æŒ

                    // ğŸ”½ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    listItem.onclick = () => {
                        const targetElement = document.getElementById(`item-${r.id}`);
                        if (targetElement) {
                            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
                            if (window.innerWidth < 768) {
                                closeSidebar(viewTitle === 'äºˆç´„' ? 'reservations' : 'owned');
                            }
                            // ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                            targetElement.classList.add('animate-pulse-once');
                            setTimeout(() => {
                                targetElement.classList.remove('animate-pulse-once');
                            }, 2000);
                        }
                    };
                    figureList.appendChild(listItem);
                });

                groupContainer.appendChild(header);
                groupContainer.appendChild(figureList);
                listTargetEl.appendChild(groupContainer);
            });
            
            lucide.createIcons();
        };

        /**
         * ğŸŒŸ æ±ç”¨çš„ãªäºˆç´„ãƒªã‚¹ãƒˆæç”»é–¢æ•°
         */
        const renderReservationList = (
            reservationsToRender,
            listTargetEl,
            noDataTargetEl,
            groupBy,
            viewTitle,
            showEditAndDelete = true
        ) => {
            listTargetEl.innerHTML = '';

            if (reservationsToRender.length === 0) {
                noDataTargetEl.classList.remove('hidden');
                return;
            } else {
                noDataTargetEl.classList.add('hidden');
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
            let groupedReservations = {};
            if (groupBy === 'none') {
                groupedReservations[viewTitle === 'äºˆç´„' ? 'å…¨äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ ' : 'å…¨æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ '] = reservationsToRender;
            } else {
                reservationsToRender.forEach(r => {
                    let groupKey;
                    if (groupBy === 'releaseDateMonth') {
                        const date = r.releaseDate;
                        groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                    } else if (groupBy === 'manufacturer') {
                        groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼æœªå®š';
                    } else if (groupBy === 'shop') {
                        groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—æœªå®š';
                    } else if (groupBy === 'scale') {
                        groupKey = r.scale && r.scale.trim() !== '' ? 'ã‚¹ã‚±ãƒ¼ãƒ«ï¼š' + r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«æœªå®š';
                    }

                    if (!groupedReservations[groupKey]) {
                        groupedReservations[groupKey] = [];
                    }
                    groupedReservations[groupKey].push(r);
                });
            }

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ (releaseDateMonthã‚’å„ªå…ˆã—ã€ãã‚Œä»¥å¤–ã¯ã‚­ãƒ¼ã§ã‚½ãƒ¼ãƒˆ)
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                if (groupBy === 'none') return 0;
                return a.localeCompare(b);
            });

            // ãƒªã‚¹ãƒˆã«æç”»
            sortedGroupKeys.forEach(groupKey => {
                const reservationsInGroup = groupedReservations[groupKey];
                
                if (groupBy !== 'none') {
                    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ
                    const groupHeader = document.createElement('div');
                    let displayKey = groupKey;
                    if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                        const [year, month] = groupKey.split(' ')[0].split('-');
                        displayKey = `${year}å¹´${month}æœˆ ${groupKey.split(' ')[1]}`;
                    }

                    groupHeader.className = 'group-header bg-fuchsia-600 text-white'; // group-headerã‚¯ãƒ©ã‚¹ã¯styleã§å®šç¾©æ¸ˆã¿
                    groupHeader.textContent = `${displayKey} (${reservationsInGroup.length}ä»¶)`;
                    listTargetEl.appendChild(groupHeader);
                }

                reservationsInGroup.forEach(reservation => {
                    const imageUrl = reservation.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image';
                    const statusClass = STATUS_COLORS[reservation.status] || 'bg-gray-200 text-gray-800 border-gray-300';
                    const card = document.createElement('div');
                    // ğŸŒŸ ä¿®æ­£: ãƒ›ãƒãƒ¼æ™‚ã®ãƒœãƒ¼ãƒ€ãƒ¼è‰²ã‚’fuchsiaã«å¤‰æ›´
                    const cardClass = `flex items-start p-4 bg-white rounded-xl shadow-lg border border-gray-200 hover:border-fuchsia-500 transition duration-200 space-x-4 dark:bg-gray-800 dark:border-gray-700 dark:hover:border-fuchsia-500`;
                    card.className = cardClass;
                    // ğŸŒŸ å€‹åˆ¥ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚«ãƒ¼ãƒ‰ã®IDã‚’ä»˜ä¸
                    card.id = `item-${reservation.id}`; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆID

                    const actionButtons = showEditAndDelete ? `
                        <div class="flex space-x-2 flex-shrink-0">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 dark:text-indigo-400 dark:hover:bg-indigo-900 transition" data-id="${reservation.id}">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900 transition" data-id="${reservation.id}" data-name="${reservation.name}">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    ` : '';

                    card.innerHTML = `
                        <div class="figure-image-wrapper">
                            <img src="${imageUrl}" alt="${reservation.name}" class="figure-image">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white truncate">${reservation.name}</h3>
                                ${actionButtons}
                            </div>
                            <div class="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-gray-600 dark:text-gray-300">
                                <p class="font-medium flex items-center sm:col-span-1">
                                    <i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                    ${viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'å—å–æ—¥'}: <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.releaseDate || 'N/A'}</span>
                                </p>
                                <p class="flex items-center sm:col-span-1">
                                    <i data-lucide="factory" class="w-4 h-4 mr-2 text-amber-500"></i>
                                    ãƒ¡ãƒ¼ã‚«ãƒ¼: <span class="text-gray-900 dark:text-white font-semibold ml-1 truncate">${reservation.manufacturer || 'N/A'}</span>
                                </p>
                                <p class="flex items-center sm:col-span-1">
                                    <i data-lucide="tag" class="w-4 h-4 mr-2 text-green-500"></i>
                                    ä¾¡æ ¼: <span class="text-gray-900 dark:text-white font-semibold ml-1">${formatCurrency(reservation.price)}</span>
                                </p>
                                ${reservation.scale ? `
                                <p class="flex items-center sm:col-span-1">
                                    <i data-lucide="ruler" class="w-4 h-4 mr-2 text-cyan-500"></i>
                                    ã‚¹ã‚±ãƒ¼ãƒ«: <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.scale}</span>
                                </p>`: ''}
                                ${reservation.shop ? `
                                <p class="flex items-center sm:col-span-1">
                                    <i data-lucide="store" class="w-4 h-4 mr-2 text-pink-500"></i>
                                    åº—èˆ—: <span class="text-gray-900 dark:text-white font-semibold ml-1 truncate">${reservation.shop}</span>
                                </p>`: ''}
                                <p class="font-medium flex items-center col-span-full">
                                    <i data-lucide="activity" class="w-4 h-4 mr-2 text-fuchsia-500"></i>
                                    çŠ¶æ³: <span class="text-xs font-bold px-2 py-0.5 rounded-full border ${statusClass} ml-1">${reservation.status}</span>
                                </p>
                            </div>
                        </div>
                    `;
                    listTargetEl.appendChild(card);
                });
            });

            lucide.createIcons(); // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            addEventListeners(); // å‹•çš„è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         * @param {string | null} docId - ç·¨é›†å¯¾è±¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã€æ–°è¦ä½œæˆã®å ´åˆã¯ null
         */
        const openModal = (docId = null) => {
            form.reset();
            document.getElementById('doc-id').value = docId;

            if (docId) {
                modalTitle.textContent = 'äºˆç´„æƒ…å ±ã‚’ç·¨é›†';
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ­ãƒ¼ãƒ‰
                const reservation = reservations.find(r => r.id === docId);
                if (reservation) {
                    document.getElementById('name').value = reservation.name || '';
                    document.getElementById('imageUrl').value = reservation.imageUrl || '';
                    document.getElementById('manufacturer').value = reservation.manufacturer || '';
                    document.getElementById('scale').value = reservation.scale || '';
                    document.getElementById('reservationDate').value = reservation.reservationDate || '';
                    document.getElementById('releaseDate').value = reservation.releaseDate || '';
                    document.getElementById('shop').value = reservation.shop || '';
                    document.getElementById('price').value = reservation.price || 0;
                    document.getElementById('status').value = reservation.status || 'äºˆç´„æ¸ˆã¿';
                    document.getElementById('orderNumber').value = reservation.orderNumber || '';
                    document.getElementById('notes').value = reservation.notes || '';
                }
            } else {
                modalTitle.textContent = 'æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ';
                document.getElementById('price').value = 0;
                document.getElementById('status').value = 'äºˆç´„æ¸ˆã¿';
                // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š (äºˆç´„æ—¥)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reservationDate').value = today;
                document.getElementById('releaseDate').value = ''; // ç™ºå£²æ—¥ã¯ç©ºæ¬„
            }

            modal.classList.remove('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢
            document.body.classList.add('overflow-hidden');
            lucide.createIcons(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        const closeModal = () => {
            modal.classList.add('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã‚’è§£é™¤
            document.body.classList.remove('overflow-hidden');
        };

        /**
         * ğŸŒŸ ä¿®æ­£: å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ (äºˆç´„ã€æ‰€æŒã€ã‚µãƒãƒªãƒ¼) ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
         */
        const renderAllViews = () => {
            // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const pendingReservations = reservations.filter(r => r.status !== STATUS_COMPLETED && r.status !== STATUS_CANCELLED);
            const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);

            // 2. çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            updateStats(currentView);

            // 3. äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const groupBy = groupBySelect.value;
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('reservations', groupBy);
            renderGroupSummary(
                pendingReservations,
                groupSummaryListEl,
                groupBy,
                'äºˆç´„'
            );
            // ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³äºˆç´„ãƒªã‚¹ãƒˆã®æç”»ã‚’è¿½åŠ 
            renderReservationList(
                pendingReservations,
                reservationListEl,
                noDataMessage,
                groupBy,
                'äºˆç´„',
                true
            );

            // 4. æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const groupByOwned = groupBySelectOwned.value;
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('owned', groupByOwned);
            renderGroupSummary(
                ownedReservations,
                groupSummaryListOwnedEl,
                // ğŸ”½ äºˆç´„ã‚·ãƒ¼ãƒˆã¨åŒæ§˜ã«ã€groupByOwnedã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
                groupByOwned,
                'æ‰€æŒ'
            );
            // ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³æ‰€æŒãƒªã‚¹ãƒˆã®æç”»ã‚’è¿½åŠ 
            renderReservationList(
                ownedReservations,
                ownedListEl,
                noOwnedDataMessage,
                groupByOwned,
                'æ‰€æŒ',
                true
            );

            // 5. èª­ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«
            loadingIndicator.classList.add('hidden');
            loadingIndicatorOwned.classList.add('hidden');
            
            // 6. ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®å†…å®¹ã‚’è¡¨ç¤º/éè¡¨ç¤ºã« (onSnapshotå¾Œã«å‘¼ã°ã‚Œã‚‹ãŸã‚)
            switchTab(currentView, false);
        };

        // ğŸŒŸ æ–°è¦è¿½åŠ : ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        const toggleSidebar = (view, isOpen) => {
            const sidebar = view === 'reservations' ? groupSummarySidebarReservations : groupSummarySidebarOwned;
            const overlay = view === 'reservations' ? sidebarOverlayReservations : sidebarOverlayOwned;

            if (!sidebar || !overlay) return;

            if (isOpen) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling body when menu is open
            } else {
                // Close
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        };

        const openSidebar = (view) => toggleSidebar(view, true);
        const closeSidebar = (view) => toggleSidebar(view, false);

        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (renderAllViewsã‚’å‘¼ã¶ã‚ˆã†ã«å¤‰æ›´)
        const setupFirestoreListener = () => {
            const q = query(collection(db, COLLECTION_NAME), orderBy('releaseDate', 'asc'));

            // onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ç›£è¦–
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                loadingIndicator.classList.remove('hidden');
                loadingIndicatorOwned.classList.remove('hidden');

                const newReservations = [];
                querySnapshot.forEach((doc) => {
                    newReservations.push({ id: doc.id, ...doc.data() });
                });
                reservations = newReservations; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªreservationsã‚’æ›´æ–°
                renderAllViews();
            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:", error);
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
                alert("Firestoreãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + error.message);
            });
            // ã‚¢ãƒ—ãƒªçµ‚äº†æ™‚ã«unsubscribeã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ãŒã€ä»Šå›ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã®ãŸã‚çœç•¥
        };


        // äºˆç´„ã®ä¿å­˜ (æ–°è¦ä½œæˆã¾ãŸã¯æ›´æ–°)
        const saveReservation = async (e) => {
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');

            const docId = document.getElementById('doc-id').value;
            const priceValue = parseInt(document.getElementById('price').value, 10);

            const data = {
                name: document.getElementById('name').value,
                imageUrl: document.getElementById('imageUrl').value,
                manufacturer: document.getElementById('manufacturer').value,
                scale: document.getElementById('scale').value,
                reservationDate: document.getElementById('reservationDate').value,
                releaseDate: document.getElementById('releaseDate').value,
                shop: document.getElementById('shop').value,
                price: isNaN(priceValue) ? 0 : priceValue,
                status: document.getElementById('status').value,
                orderNumber: document.getElementById('orderNumber').value,
                notes: document.getElementById('notes').value,
                updatedAt: serverTimestamp(),
            };

            // å¿…é ˆãƒã‚§ãƒƒã‚¯
            if (!data.name || !data.reservationDate || !data.releaseDate || !data.status) {
                alert("å¿…é ˆé …ç›®ï¼ˆãƒ•ã‚£ã‚®ãƒ¥ã‚¢åã€äºˆç´„æ—¥ã€ç™ºå£²äºˆå®šæ—¥ã€çŠ¶æ³ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
                return;
            }

            try {
                if (docId) {
                    // æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
                    await setDoc(doc(db, COLLECTION_NAME, docId), data, { merge: true });
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:", docId);
                } else {
                    // æ–°è¦ä½œæˆ
                    await addDoc(collection(db, COLLECTION_NAME), { ...data, createdAt: serverTimestamp() });
                    console.log("æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
                }
                closeModal();
            } catch (error) {
                console.error("äºˆç´„ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };

        // äºˆç´„ã®å‰Šé™¤ (å¤‰æ›´ãªã—)
        const deleteReservation = async () => {
            if (!docIdToDelete) return;
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, COLLECTION_NAME, docIdToDelete));
                console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ:", docIdToDelete);
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            } catch (error) {
                console.error("äºˆç´„ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ  (ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«å†è¿½åŠ )
        const addEventListeners = () => {
            // ç·¨é›†ãƒœã‚¿ãƒ³
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    openModal(e.currentTarget.dataset.id);
                };
            });

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    docIdToDelete = e.currentTarget.dataset.id;
                    const itemName = e.currentTarget.dataset.name || 'ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ';
                    deleteItemNameEl.textContent = itemName;
                    deleteModal.classList.remove('hidden');
                };
            });
            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œã¯DOMãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨­å®š
            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼å†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯ renderGroupSummary å†…ã§å‡¦ç†ã•ã‚Œã¾ã™
        };

        /**
         * ğŸŒŸ ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•° (å¤‰æ›´: å›ºå®šãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ )
         * @param {string} view - 'reservations' or 'owned'
         * @param {boolean} updateHistory - å±¥æ­´ã‚’æ›´æ–°ã™ã‚‹ã‹ã©ã†ã‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true)
         */
        const switchTab = (view, updateHistory = true) => {
            // 1. DOMè¦ç´ ã®å–å¾—
            const reservationsBtn = document.getElementById('tab-reservations');
            const ownedBtn = document.getElementById('tab-owned');
            const reservationsPage = document.getElementById('page-reservations');
            const ownedPage = document.getElementById('page-owned');
            // ğŸ”½ è¿½åŠ : å›ºå®šãƒœã‚¿ãƒ³ã®å–å¾—
            const fixedReservationsBtn = document.getElementById('fixed-summary-btn-reservations');
            const fixedOwnedBtn = document.getElementById('fixed-summary-btn-owned');

            // 2. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
            if (view === 'reservations') {
                reservationsBtn.classList.add(...ACTIVE_CLASSES);
                reservationsBtn.classList.remove(...INACTIVE_CLASSES);
                ownedBtn.classList.add(...INACTIVE_CLASSES);
                ownedBtn.classList.remove(...ACTIVE_CLASSES);
                
                // ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
                reservationsPage.classList.remove('hidden');
                ownedPage.classList.add('hidden');
                
                // ğŸ”½ å›ºå®šãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
                fixedReservationsBtn.classList.remove('hidden');
                fixedOwnedBtn.classList.add('hidden');

            } else {
                ownedBtn.classList.add(...ACTIVE_CLASSES);
                ownedBtn.classList.remove(...INACTIVE_CLASSES);
                reservationsBtn.classList.add(...INACTIVE_CLASSES);
                reservationsBtn.classList.remove(...ACTIVE_CLASSES);

                // ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
                ownedPage.classList.remove('hidden');
                reservationsPage.classList.add('hidden');
                
                // ğŸ”½ å›ºå®šãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
                fixedOwnedBtn.classList.remove('hidden');
                fixedReservationsBtn.classList.add('hidden');
            }

            currentView = view;
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            updateStats(view);
            
            // å±¥æ­´ã®æ›´æ–° (ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ã«å¯¾å¿œ)
            if (updateHistory) {
                history.pushState({ view: view }, '', `?view=${view}`);
            }
        };

        // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³ã§ã®å‹•ä½œ
        window.onpopstate = (event) => {
            const view = event.state && event.state.view ? event.state.view : 'reservations';
            switchTab(view, false); // å±¥æ­´ã‚’æ›´æ–°ã›ãšã«ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        };


        // åˆæœŸåŒ–å‡¦ç†
        const init = () => {
            
            // 1. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            openModalBtn.onclick = () => openModal();
            closeModalBtn.onclick = () => closeModal();
            modalCloseIcon.onclick = () => closeModal();
            form.onsubmit = saveReservation;

            cancelDeleteBtn.onclick = () => deleteModal.classList.add('hidden');
            confirmDeleteBtn.onclick = deleteReservation;
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã®è¨­å®š
            const toggleBtn = document.getElementById('toggle-dark-mode');
            const toggleDarkMode = () => {
                document.documentElement.classList.toggle('dark');
                // çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
                localStorage.setItem('dark-mode', document.documentElement.classList.contains('dark') ? 'enabled' : 'disabled');
            };
            // èµ·å‹•æ™‚ã«localStorageã‹ã‚‰çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
            if (localStorage.getItem('dark-mode') === 'enabled') {
                document.documentElement.classList.add('dark');
            }
            if (toggleBtn) {
                toggleBtn.onclick = toggleDarkMode;
            }
            
            // ğŸŒŸ 6. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            tabReservationsBtn.onclick = () => switchTab('reservations');
            tabOwnedBtn.onclick = () => switchTab('owned');
            
            // äºˆç´„ãƒšãƒ¼ã‚¸ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            groupBySelect.onchange = () => {
                if (currentView === 'reservations') {
                    renderAllViews();
                }
            };
            
            // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (groupBySelectOwned) {
                groupBySelectOwned.onchange = () => {
                    if (currentView === 'owned') {
                        renderAllViews();
                    }
                };
            }
            
            // ğŸŒŸ 7. è¿½åŠ : ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (fixedãƒœã‚¿ãƒ³ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å¤‰æ•°ã¯æ—¢ã«æ›´æ–°æ¸ˆã¿)
            // äºˆç´„ãƒ“ãƒ¥ãƒ¼
            openSummaryBtnReservations.onclick = () => openSidebar('reservations'); // fixed-summary-btn-reservations ã«æ¥ç¶š
            closeSummaryBtnReservations.onclick = () => closeSidebar('reservations');
            sidebarOverlayReservations.onclick = () => closeSidebar('reservations');

            // æ‰€æŒãƒ“ãƒ¥ãƒ¼
            openSummaryBtnOwned.onclick = () => openSidebar('owned'); // fixed-summary-btn-owned ã«æ¥ç¶š
            closeSummaryBtnOwned.onclick = () => closeSidebar('owned');
            sidebarOverlayOwned.onclick = () => closeSidebar('owned');

            // 2. Firebaseã®åˆæœŸåŒ–ã¨æ¥ç¶š (ã‚³ãƒ¼ãƒ‰ã®æœ€å¾Œå°¾ã«ç§»å‹•)
            // 3. åˆæœŸã‚¿ãƒ–ã®æ±ºå®š (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã«å¾“ã†)
            const urlParams = new URLSearchParams(window.location.search);
            const initialView = urlParams.get('view') || 'reservations';
            
            // 4. Firebaseæ¥ç¶šè©¦è¡Œ
            tryConnectFirebase(initialView);
        };

        /**
         * Firebaseã¸ã®æ¥ç¶šã‚’è©¦ã¿ã‚‹
         * @param {string} initialView - åˆæœŸè¡¨ç¤ºã™ã‚‹ãƒ“ãƒ¥ãƒ¼
         */
        const tryConnectFirebase = async (initialView) => {
            // firebaseConfigãŒç©ºã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_API_KEY')) {
                authInfoEl.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5 mr-3 inline-block"></i>ã€ã‚¨ãƒ©ãƒ¼ã€‘` +
                                       `Firebaseè¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚` + 
                                       `\`firebaseConfig\`ã«æ­£ã—ã„è¨­å®šã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                
                // æ¥ç¶šå¤±æ•—æ™‚ã‚‚åˆæœŸè¡¨ç¤ºã‚’é©ç”¨
                currentView = initialView;
                switchTab(initialView, false);
                // ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦çµ‚äº†
                lucide.createIcons();
                return;
            }

            try {
                // FirebaseåˆæœŸåŒ–
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // åŒ¿åèªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³
                await signInAnonymously(auth);
                console.log("FirebaseåŒ¿åèªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");

                authInfoEl.innerHTML = '<i data-lucide="cloud-check" class="w-5 h-5 mr-3 inline-block"></i>Firebaseã«æ¥ç¶šæ¸ˆã¿ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-green-100', 'border-green-500', 'text-green-800');

                lucide.createIcons();
                
                // Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupFirestoreListener();
                
                // åˆæœŸè¡¨ç¤ºã‚’è¨­å®š (Listenerå†…ã§renderAllViewsãŒå‘¼ã°ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯currentViewã‚’è¨­å®šã™ã‚‹ã®ã¿)
                currentView = initialView;

            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                authInfoEl.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5 mr-3 inline-block"></i>Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                lucide.createIcons();
            }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>