<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* === ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ === */
        body {
            font-family: 'Inter', sans-serif;
            /* èƒŒæ™¯è‰²ã¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ */
            background: linear-gradient(135deg, #e0f7fa 0%, #f9f0ff 100%);
            /* ğŸ”½ ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ¿ƒã„è‰² (#1f2937) ã«æˆ»ã—ã€å„è¦ç´ ã§ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’å†èª¿æ•´ */
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            /* ğŸ”½ ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºãŒä¸»ï¼‰ */
            font-size: 0.95rem;
        }
        
        /* ğŸ”½ ä¿®æ­£: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§æ¨™æº–ã‚µã‚¤ã‚ºã«æˆ»ã™ */
        @media (min-width: 768px) {
            body {
                font-size: 1rem;
            }
        }
        
        /* ğŸ”½ ä¿®æ­£: ã‚«ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã‚’æ˜ç¤ºçš„ã«ç™½ï¼ˆã¾ãŸã¯éå¸¸ã«æ˜ã‚‹ã„è‰²ï¼‰ã«è¨­å®š */
        .bg-white { background-color: #ffffff !important; }
        
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important; }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰) */
        .reservation-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* ç´«ç³»ã®ã‚µãƒ ãƒã‚¤ãƒ« */
            border-radius: 10px;
        }
        .reservation-list::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        /* ğŸ”½ ä¿®æ­£: input/select ã®ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ˜ç¢ºã«é»’ç³»çµ±ã«è¨­å®š (èƒŒæ™¯è‰²æŒ‡å®šã‚’å‰Šé™¤) */
        input:not(.dark *), select:not(.dark *) {
             color: #1f2937; /* æ¿ƒã„æ–‡å­—è‰²ã‚’ç¶­æŒ */
             /* èƒŒæ™¯è‰²ã¯HTMLã®bg-whiteã‚¯ãƒ©ã‚¹ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ */
        }

        /* ğŸ”½ 1. çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’é»’ã«å›ºå®š */
        /* ã‚«ãƒ¼ãƒ‰ã®æ•°å­— (text-2xl font-bold text-gray-900) ã«å½“ãŸã‚‹è¦ç´ ã®ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®è‰²ã‚’é»’ã«å›ºå®š */
        .bg-white p.text-2xl.font-bold.text-gray-900 {
            color: #1f2937 !important;
        }

        /* ğŸ”½ 2. äºˆç´„ãƒªã‚¹ãƒˆå†…ã®æƒ…å ±ï¼ˆåå‰ä»¥å¤–ï¼‰ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã«å›ºå®š */
        /* text-gray-600 ã®è‰²ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã« (text-gray-700ç›¸å½“) */
        .bg-white .text-gray-600 {
            color: #374151 !important; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        }
        /* ğŸ”½ äºˆç´„ãƒªã‚¹ãƒˆå†…ã®æƒ…å ±ï¼ˆspanã‚¿ã‚°ã§å¼·èª¿ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ï¼‰ã‚’é»’ã«å›ºå®š */
        .bg-white .text-gray-900 {
            color: #1f2937 !important; /* é»’ã«è¿‘ã„è‰² */
        }
        
        /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        .dark body {
            background: #1f2937; /* æš—ã„èƒŒæ™¯ */
            color: #f3f4f6; /* æ˜ã‚‹ã„ãƒ†ã‚­ã‚¹ãƒˆ */
        }
        
        /* ğŸŒŸ è¿½åŠ : ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã«æœ¬æ–‡ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
        body.overflow-hidden {
            overflow: hidden;
        }

        /* ğŸ”½ ã“ã“ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚«ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã§ã™ (æ¿ƒã„ã‚°ãƒ¬ãƒ¼) */
        .dark .bg-white {
            background-color: #374151 !important; /* æš—ã‚ã®ã‚°ãƒ¬ãƒ¼ */
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
        .dark .shadow-2xl { 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important; 
        }
        
        /* ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’fuchsia-600/text-whiteã«ä¿®æ­£ */
        .group-header {
            background-color: #ec4899; /* fuchsia-600 */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .dark .group-header {
            background-color: #db2777; /* fuchsia-700 or fuchsia-600 on dark */
            color: #f3f4f6;
        }
        
        /* ğŸ”½ ã“ã“ã§ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç™½è‰²ç³»çµ±ã«ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ */
        .dark input, .dark select {
            background-color: #4b5563; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            color: #f3f4f6; /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
            border-color: #6b7280;
        }
        
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .text-gray-900 { color: #f3f4f6 !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-800 { color: #f3f4f6 !important; } /* ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã¨äºˆç´„ãƒªã‚¹ãƒˆã®H2ã‚¿ã‚°ãªã©ã«å¯¾å¿œ */
        .dark .text-gray-700 { color: #e5e7eb !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-600 { color: #d1d5db !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-500 { color: #9ca3af !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark p.text-2xl.font-bold.text-gray-900 { color: #f3f4f6 !important; } /* çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®æ•°å­— */


        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        .dark .reservation-list::-webkit-scrollbar-thumb {
            background-color: #8b5cf6; 
        }
        .dark .reservation-list::-webkit-scrollbar-track {
            background: #4b5563;
        }

        .reservation-list {
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã€æœ€å¤§é«˜ã•ã‚’è¨­å®š */
            min-height: 70vh;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  */
        .reservation-list::-webkit-scrollbar {
            width: 8px;
        }
        .reservation-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* ç´«ç³»ã®ã‚µãƒ ãƒã‚¤ãƒ« */
            border-radius: 10px;
        }
        .reservation-list::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        /* ç”»åƒã‚’ã‚«ãƒ¼ãƒ‰ã«åã‚ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .figure-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0; /* ç”»åƒãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰ (ğŸŒŸ è¿½åŠ ) */
        @keyframes pulse-once {
          0% { background-color: #8b5cf6; }
          50% { background-color: #a78bfa; }
          100% { background-color: #8b5cf6; }
        }
        .animate-pulse-once {
            animation: pulse-once 2s ease-out;
        }

        /* ğŸ”½ å³ä¸‹å›ºå®šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .fixed-menu-container { /* åå‰ã‚’ä¿®æ­£: fixed-menu-button -> fixed-menu-container */
            position: fixed;
            bottom: 20px; /* ä¸‹ã‹ã‚‰ã®è·é›¢ */
            right: 20px; /* å³ã‹ã‚‰ã®è·é›¢ */
            z-index: 51; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šæ‰‹å‰ */
            display: flex;
            flex-direction: column; /* ç¸¦ã«ä¸¦ã¹ã‚‹ */
            gap: 15px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            align-items: flex-end; /* å³æƒãˆ */
        }
        /* ğŸ”½ æ–°ã—ã„äºˆç´„è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .fixed-add-button {
            /* ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããã—ã¦ç›®ç«‹ãŸã›ã‚‹ (Tailwindã®p-4ã¨w-14 h-14ç›¸å½“) */
            width: 56px;
            height: 56px;
            padding: 1rem; /* p-4 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ğŸ”½ ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶­æŒã—ã¤ã¤èª¿æ•´ */
        .fixed-summary-button {
            /* ã‚µã‚¤ã‚ºã‚’å°‘ã—å°ã•ãã—ã¦åŒºåˆ¥ã™ã‚‹ (Tailwindã®p-3ã¨w-12 h-12ç›¸å½“) */
            width: 48px;
            height: 48px;
            padding: 0.75rem; /* p-3 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* mdã‚µã‚¤ã‚ºä»¥ä¸Šã§ã¯éè¡¨ç¤ºã«æˆ»ã™ */
        @media (min-width: 768px) {
            .fixed-menu-container {
                display: none;
            }
        }
        
        /* ğŸ”½ ä¿®æ­£ç®‡æ‰€: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠãŒç”»é¢å…¨ä½“ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        .scrollable-modal-container {
            /* fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4 */
            overflow-y: auto; /* ğŸ‘ˆ ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ãªã‚‹ */
        }
        
        /* ğŸ”½ ä¿®æ­£ç®‡æ‰€: ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”»é¢ä¸­å¤®ã«é…ç½®ã—ã¤ã¤é«˜ã•ã‚’åˆ¶é™ã™ã‚‹ */
        .modal-content-wrapper {
            /* bg-white w-full max-w-xl rounded-2xl shadow-2xl p-8 relative transform transition-all duration-300 */
            max-height: calc(100vh - 40px); /* ç”»é¢ã®é«˜ã•ã‹ã‚‰ä¸Šä¸‹20pxã®ãƒãƒ¼ã‚¸ãƒ³ã‚’å¼•ã„ãŸé«˜ã•ã«åˆ¶é™ */
            overflow-y: auto; /* ğŸ‘ˆ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ãªã‚‹ */
            margin-top: auto; /* Flexã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ä¸Šä¸‹ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã«å¿…è¦ */
            margin-bottom: auto;
        }
        
    </style>
</head>
<body>
    <div id="app" class="max-w-7xl mx-auto">
        
        <div id="auth-info-firebase" class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-xl shadow-lg text-sm text-yellow-800 font-semibold flex items-center">
            <i data-lucide="cloud-off" class="w-5 h-5 mr-3 inline-block"></i>
            ã€æœªæ¥ç¶šã€‘`firebaseConfig`ã‚’è¨­å®šã—ã¦ã€Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 flex items-center flex-grow justify-center">
                <i data-lucide="box" class="w-8 h-8 text-fuchsia-600"></i>
            </h1>
            <button id="toggle-dark-mode" class="p-3 rounded-full text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition duration-300 transform hover:scale-110">
                <i data-lucide="moon" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="mb-8">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-reservations" data-tab="reservations" class="tab-button py-3 px-4 font-medium text-lg whitespace-nowrap transition duration-200 rounded-lg bg-fuchsia-600 text-white shadow-md dark:bg-fuchsia-700 dark:text-white">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-2 inline-block"></i>
                        äºˆç´„ãƒªã‚¹ãƒˆ
                    </button>
                    <button id="tab-owned" data-tab="owned" class="tab-button py-3 px-4 font-medium text-lg whitespace-nowrap transition duration-200 rounded-lg text-gray-500 hover:text-fuchsia-600 hover:bg-fuchsia-50 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                        <i data-lucide="archive" class="w-5 h-5 mr-2 inline-block"></i>
                        æ‰€æŒãƒªã‚¹ãƒˆ
                    </button>
                </nav>
            </div>
        </div>
        
        <div id="stats" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            </div>

        <div id="tab-content-container">

            <div id="page-reservations" class="tab-page">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <button id="open-modal-btn-desktop" class="hidden md:w-auto md:px-8 md:py-3 md:bg-fuchsia-600 md:text-white md:font-bold md:rounded-full md:shadow-xl md:hover:bg-fuchsia-700 md:transition md:duration-300 md:transform md:hover:scale-105 md:flex md:items-center md:justify-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                        æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ 
                    </button>
                    <div class="w-full md:w-auto"></div> <div class="flex items-center space-x-3">
                        <label for="group-by-select" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">ç™ºå£²æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>

                <div id="main-content-wrapper-reservations" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 md:col-span-3 md:h-fit md:sticky md:top-4 md:p-6 md:rounded-3xl md:shadow-2xl md:border md:border-gray-100 p-6 rounded-r-3xl shadow-2xl border-r border-t border-b border-gray-200 overflow-y-auto">
                        <button id="close-summary-btn-reservations" class="md:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-900 p-2 rounded-full hover:bg-gray-100 transition z-50">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <h2 id="summary-title-reservations" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-3 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                äºˆç´„ãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="reservation-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>ä¸Šã®ã€Œæ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar-overlay-reservations" class="hidden md:hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-40 transition-opacity duration-300"></div>
            </div>
            
            <div id="page-owned" class="tab-page hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <div class="flex-grow"></div> 
                    <div class="flex items-center space-x-3">
                        <label for="group-by-select-owned" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select-owned" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">è³¼å…¥/å—å–æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>
                <div id="main-content-wrapper-owned" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar-owned" class="fixed inset-y-0 left-0 w-80 bg-white z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 md:col-span-3 md:h-fit md:sticky md:top-4 md:p-6 md:rounded-3xl md:shadow-2xl md:border md:border-gray-100 p-6 rounded-r-3xl shadow-2xl border-r border-t border-b border-gray-200 overflow-y-auto">
                        <button id="close-summary-btn-owned" class="md:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-900 p-2 rounded-full hover:bg-gray-100 transition z-50">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <h2 id="summary-title-owned" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list-owned" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-3 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="archive" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                æ‰€æŒãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator-owned" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="owned-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-owned-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€å—ã‘å–ã‚Šæ¸ˆã¿ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>äºˆç´„ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†ã€ã«æ›´æ–°ã—ã¦ãã ã•ã„ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar-overlay-owned" class="hidden md:hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-40 transition-opacity duration-300"></div>
            </div>

        </div>
        </div>

    <div id="mobile-fixed-menu" class="fixed-menu-container md:hidden">
        
        <button id="open-modal-btn-mobile" 
            class="fixed-add-button bg-fuchsia-600 text-white rounded-full shadow-2xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105" 
            aria-label="æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <button id="fixed-summary-btn-reservations" 
            class="fixed-summary-button bg-fuchsia-600 text-white rounded-full shadow-2xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105" 
            aria-label="ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’é–‹ã (äºˆç´„)">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        
        <button id="fixed-summary-btn-owned" 
            class="fixed-summary-button bg-fuchsia-600 text-white rounded-full shadow-2xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105 hidden" 
            aria-label="ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’é–‹ã (æ‰€æŒ)">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </div>
    
    <div id="reservation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4 scrollable-modal-container">
        <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-8 relative transform transition-all duration-300 modal-content-wrapper">
            <h2 id="modal-title" class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ </h2>
            
            <form id="reservation-form" class="space-y-5">
                <input type="hidden" id="doc-id">

                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å <span class="text-red-500">*</span></label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>
                
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700">ç”»åƒURL</label>
                    <input type="url" id="imageUrl" placeholder="http://..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="manufacturer" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ã‚«ãƒ¼å/ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
                        <input type="text" id="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="scale" class="block text-sm font-medium text-gray-700">ã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ± (ä¾‹: 1/7, HG)</label>
                        <input type="text" id="scale" placeholder="ä¾‹: 1/7" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="reservationDate" class="block text-sm font-medium text-gray-700">äºˆç´„æ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="reservationDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                    <div>
                        <label for="releaseDate" class="block text-sm font-medium text-gray-700">ç™ºå£²/å¼•æ¸¡äºˆå®šæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="releaseDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="shop" class="block text-sm font-medium text-gray-700">è³¼å…¥åº—èˆ—/äºˆç´„ã‚µã‚¤ãƒˆ</label>
                        <input type="text" id="shop" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">ä¾¡æ ¼ (å††)</label>
                        <input type="number" id="price" min="0" value="0" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">äºˆç´„çŠ¶æ³ <span class="text-red-500">*</span></label>
                    <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150 bg-white">
                        <option value="äºˆç´„æ¸ˆã¿">äºˆç´„æ¸ˆã¿</option>
                        <option value="æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰">æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰</option>
                        <option value="ç™ºé€é€£çµ¡å¾…ã¡">ç™ºé€é€£çµ¡å¾…ã¡</option>
                        <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        <option value="å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†">å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="orderNumber" class="block text-sm font-medium text-gray-700">æ³¨æ–‡ç•ªå·/äºˆç´„ç•ªå·</label>
                        <input type="text" id="orderNumber" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">å‚™è€ƒæ¬„</label>
                        <input type="text" id="notes" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="close-modal-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-8 py-2 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-105">ä¿å­˜</button>
                </div>
            </form>
            <button id="modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold text-red-600 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                å‰Šé™¤ã®ç¢ºèª
            </h3>
            <p class="text-gray-700">æœ¬å½“ã«ã“ã®äºˆç´„æƒ…å ±ï¼ˆ<span id="delete-item-name" class="font-bold"></span>ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="confirm-delete-btn" class="px-8 py-2 bg-red-600 text-white font-bold rounded-full shadow-md hover:bg-red-700 transition duration-150">å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <div id="figure-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4 scrollable-modal-container">
        <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-8 relative transform transition-all duration-300 modal-content-wrapper">
            <h2 id="detail-modal-title" class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2 flex items-center">
                <i data-lucide="info" class="w-7 h-7 mr-2 text-indigo-500"></i>
                ãƒ•ã‚£ã‚®ãƒ¥ã‚¢è©³ç´°æƒ…å ±
            </h2>

            <div id="detail-modal-content" class="space-y-4">
                </div>
            
            <div class="flex justify-end pt-6">
                 <button type="button" id="close-detail-modal-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">é–‰ã˜ã‚‹</button>
            </div>

            <button id="detail-modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰
        setLogLevel('Debug');
        
        // =========================================================
        // ğŸš¨ ã€é‡è¦ã€‘ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // (æ·»ä»˜ã‚³ãƒ¼ãƒ‰ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™)
        // =========================================================
    	const firebaseConfig = {
  		apiKey: "AIzaSyD9jmIafM4JjpJyv65WjFWlbV_n9dssUt4",
  		authDomain: "figure-manager-app.firebaseapp.com",
  		projectId: "figure-manager-app",
  		storageBucket: "figure-manager-app.firebaseapp.com",
  		messagingSenderId: "487492839040",
  		appId: "1:487492839040:web:a43419d861335f259da865",
  		measurementId: "G-19FTK3XTW4"
	};
        // =========================================================
        // ğŸš¨ ã“ã“ã‹ã‚‰ä¸‹ã¯ç·¨é›†ã—ãªã„ã§ãã ã•ã„
        // =========================================================

        let db, auth;
        let reservations = [];
        const COLLECTION_NAME = 'figure_reservations_data'; 

        // DOMè¦ç´ ã®å–å¾—
        const reservationListEl = document.getElementById('reservation-list');
        // ğŸ”½ ä¿®æ­£: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚’åˆ†ã‘ã‚‹
        const openModalBtnDesktop = document.getElementById('open-modal-btn-desktop');
        const openModalBtnMobile = document.getElementById('open-modal-btn-mobile'); 
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');
        const modal = document.getElementById('reservation-modal');
        const form = document.getElementById('reservation-form');
        const modalTitle = document.getElementById('modal-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');
        const statsEl = document.getElementById('stats');
        const authInfoEl = document.getElementById('auth-info-firebase');
        const groupBySelect = document.getElementById('group-by-select'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿
        const groupSummaryListEl = document.getElementById('group-summary-list'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼è¦ç´ 
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteItemNameEl = document.getElementById('delete-item-name');
        let docIdToDelete = null;

        // ğŸŒŸ æ–°è¦è¿½åŠ ã•ã‚ŒãŸDOMè¦ç´ ã¨çŠ¶æ…‹å¤‰æ•°
        const tabReservationsBtn = document.getElementById('tab-reservations');
        const tabOwnedBtn = document.getElementById('tab-owned');
        const reservationsPage = document.getElementById('page-reservations');
        const ownedPage = document.getElementById('page-owned');
        const groupBySelectOwned = document.getElementById('group-by-select-owned');
        const groupSummaryListOwnedEl = document.getElementById('group-summary-list-owned');
        const ownedListEl = document.getElementById('owned-list');
        const loadingIndicatorOwned = document.getElementById('loading-indicator-owned');
        const noOwnedDataMessage = document.getElementById('no-owned-data-message');
        const summaryTitleReservationsEl = document.getElementById('summary-title-reservations');
        const summaryTitleOwnedEl = document.getElementById('summary-title-owned');
        const openSummaryBtnReservations = document.getElementById('fixed-summary-btn-reservations');
        const closeSummaryBtnReservations = document.getElementById('close-summary-btn-reservations');
        const sidebarOverlayReservations = document.getElementById('sidebar-overlay-reservations');
        const sidebarReservationsEl = document.getElementById('group-summary-sidebar');
        const openSummaryBtnOwned = document.getElementById('fixed-summary-btn-owned');
        const closeSummaryBtnOwned = document.getElementById('close-summary-btn-owned');
        const sidebarOverlayOwned = document.getElementById('sidebar-overlay-owned');
        const sidebarOwnedEl = document.getElementById('group-summary-sidebar-owned');
        const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');

        // ğŸŒŸ æ–°è¦è¿½åŠ : è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        const detailModal = document.getElementById('figure-detail-modal');
        const detailModalTitleEl = document.getElementById('detail-modal-title');
        const detailModalContentEl = document.getElementById('detail-modal-content');
        const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
        const detailModalCloseIcon = document.getElementById('detail-modal-close-icon');


        // çŠ¶æ…‹ç®¡ç†
        let currentView = 'reservations'; // 'reservations' or 'owned'
        const STATUS_COMPLETED = 'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†';
        const STATUS_CANCELLED = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        const STATUS_COLORS = {
            'äºˆç´„æ¸ˆã¿': 'bg-blue-100 text-blue-800 border-blue-300',
            'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰': 'bg-indigo-100 text-indigo-800 border-indigo-300',
            'ç™ºé€é€£çµ¡å¾…ã¡': 'bg-purple-100 text-purple-800 border-purple-300',
            'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 'bg-red-100 text-red-800 border-red-300',
            'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†': 'bg-green-100 text-green-800 border-green-300',
        };
        const ACTIVE_CLASSES = ['bg-fuchsia-600', 'text-white', 'shadow-md', 'dark:bg-fuchsia-700', 'dark:text-white'];
        const INACTIVE_CLASSES = ['text-gray-500', 'hover:text-fuchsia-600', 'hover:bg-fuchsia-50', 'dark:text-gray-400', 'dark:hover:bg-gray-700', 'dark:hover:text-white', 'bg-fuchsia-600', 'text-white', 'shadow-md', 'dark:bg-fuchsia-700', 'dark:text-white'];


        // ğŸ”½ ä¿®æ­£: ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚­ãƒ¼ã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚° (ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã«è¿½åŠ )
        const GROUP_BY_NAMES = {
            'none': 'å…¨ã‚¢ã‚¤ãƒ†ãƒ ',
            'releaseDateMonth': 'ç™ºå£²æœˆ',
            'manufacturer': 'ãƒ¡ãƒ¼ã‚«ãƒ¼',
            'shop': 'è³¼å…¥åº—èˆ—',
            'scale': 'ã‚¹ã‚±ãƒ¼ãƒ«',
        };

        /**
         * ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚­ãƒ¼ã‚’æ—¥æœ¬èªã®è¡¨ç¤ºåã«å¤‰æ›ã™ã‚‹
         */
        const getGroupByDisplayName = (groupBy) => {
            return GROUP_BY_NAMES[groupBy] || GROUP_BY_NAMES['none'];
        };

        /**
         * ğŸŒŸ ä¿®æ­£: ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        const updateSummaryTitle = (view, groupBy) => {
            const baseName = GROUP_BY_NAMES[groupBy] || 'ã‚°ãƒ«ãƒ¼ãƒ—';
            let titleText;
            if (groupBy === 'none') {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„å ´åˆã¯ã€HTMLã§è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¶­æŒ (ä¾‹: ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼)
                titleText = view === 'reservations' ? 'ã™ã¹ã¦' : 'ã™ã¹ã¦';
            } else {
                // ã”è¦æœ›ã«åŸºã¥ãã€ã‚°ãƒ«ãƒ¼ãƒ—åã®ã¿ã«å¤‰æ›´
                titleText = baseName;
            }
            const titleEl = view === 'reservations' ? summaryTitleReservationsEl : summaryTitleOwnedEl;
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¿æŒ
            const iconHtml = `<i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>`;
            if (titleEl) {
                titleEl.innerHTML = iconHtml + titleText;
                lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³ã®å†æç”»
            }
        };

        /**
         * ä¾¡æ ¼ã‚’æ—¥æœ¬å††ã®å½¢å¼ï¼ˆÂ¥1,234ï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', minimumFractionDigits: 0 }).format(amount);
        };

        /**
         * çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         * ğŸ”½ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨ colorClass ã®å¼•æ•°ã‚’å‰Šé™¤
         */
        const createStatCard = (title, value) => {
            return `
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 text-left">${title}</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1 text-left">${value}</p>
                    </div>
                </div>
            `;
        };

        /**
         * ğŸŒŸ çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ (äºˆç´„ã¨æ‰€æŒãƒ“ãƒ¥ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆã‚‹)
         */
        const updateStats = (view) => {
            const thisYear = new Date().getFullYear();
            const thisMonth = new Date().getMonth(); // 0-11

            if (view === 'reservations') {
                // --- äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£) ---
                const pendingReservations = reservations.filter(r => r.status !== STATUS_COMPLETED && r.status !== STATUS_CANCELLED);
                const totalReservations = reservations.length;
                let totalReserved = 0;
                let upcomingPaymentTotal = 0;

                pendingReservations.forEach(r => {
                    totalReserved += r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null;
                    if (releaseDate) {
                        const releaseMonth = releaseDate.getMonth();
                        const releaseYear = releaseDate.getFullYear();
                        // ä»Šæœˆ (currentMonth) ã¾ãŸã¯æ¥æœˆ (currentMonth + 1) ã®ç™ºå£²äºˆå®š
                        if (releaseYear === thisYear && (releaseMonth === thisMonth || releaseMonth === (thisMonth + 1) % 12) ||
                            (releaseYear === thisYear + 1 && thisMonth === 11 && releaseMonth === 0)) {
                            upcomingPaymentTotal += r.price || 0;
                        }
                    }
                });

                // ğŸ”½ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨ colorClass ã®å¼•æ•°ã‚’å‰Šé™¤
                statsEl.innerHTML = `
                    ${createStatCard('äºˆç´„ç·ä»¶æ•° (å…¨ãƒ‡ãƒ¼ã‚¿)', totalReservations)}
                    ${createStatCard('æœªå®Œäº†ä»¶æ•°', pendingReservations.length)}
                    ${createStatCard('æ”¯æ‰•ã„äºˆå®šç·é¡', formatCurrency(totalReserved))}
                    ${createStatCard('ä»Šæœˆãƒ»æ¥æœˆæ”¯æ‰•äºˆå®šé¡', formatCurrency(upcomingPaymentTotal))}
                `;

            } else if (view === 'owned') {
                // --- æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æ–°è¦ãƒ­ã‚¸ãƒƒã‚¯) ---
                const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);
                let totalOwnedPrice = 0;
                let thisYearOwnedCount = 0;

                ownedReservations.forEach(r => {
                    totalOwnedPrice += r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null; // releaseDateã‚’ã“ã“ã§ã¯ã€Œå–å¾—æ—¥ã€ã¨è¦‹ãªã™
                    if (releaseDate && releaseDate.getFullYear() === thisYear) {
                        thisYearOwnedCount++;
                    }
                });

                const totalOwnedCount = ownedReservations.length;

                // æ‰€æŒãƒ“ãƒ¥ãƒ¼ç”¨ã®çµ±è¨ˆã‚«ãƒ¼ãƒ‰
                // ğŸ”½ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨ colorClass ã®å¼•æ•°ã‚’å‰Šé™¤
                statsEl.innerHTML = `
                    ${createStatCard('æ‰€æŒç·ä»¶æ•°', totalOwnedCount)}
                    ${createStatCard('æœ¬å¹´å–å¾—ä»¶æ•°', thisYearOwnedCount)}
                    ${createStatCard('ç·è³¼å…¥é¡', formatCurrency(totalOwnedPrice))}
                    ${createStatCard('å¹³å‡å˜ä¾¡', totalOwnedCount > 0 ? formatCurrency(Math.round(totalOwnedPrice / totalOwnedCount)) : formatCurrency(0))}
                `;
            }

            // ğŸ”½ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ãŒãªã„ãŸã‚ã€ã“ã®è¡Œã¯å‰Šé™¤ã¾ãŸã¯ãã®ã¾ã¾æ®‹ã—ã¦ã‚‚å½±éŸ¿ãªã—
            lucide.createIcons();
        };


        /**
         * ğŸŒŸ ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹
         */
        const renderGroupSummary = (reservationsToRender, groupSummaryTargetEl, groupBy, viewTitle) => {
            groupSummaryTargetEl.innerHTML = '';

            if (reservationsToRender.length === 0) {
                groupSummaryTargetEl.innerHTML = `
                    <p class="text-gray-500 text-sm p-2">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                `;
                return;
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯
            let groupedReservations = {};
            if (groupBy === 'none') {
                // ã‚­ãƒ¼ã¯ã€Œå…¨æœªå®Œäº†ã‚¢ã‚¤ãƒ†ãƒ ã€ã¾ãŸã¯ã€Œå…¨æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã€
                const totalViewTitle = viewTitle === 'äºˆç´„' ? 'å…¨äºˆç´„ãƒ•ã‚£ã‚®ãƒ¥ã‚¢' : 'å…¨æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢';
                groupedReservations[totalViewTitle] = reservationsToRender;
            } else {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
                reservationsToRender.forEach(r => {
                    let groupKey;
                    if (groupBy === 'releaseDateMonth') {
                        const date = r.releaseDate;
                        groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                    } else if (groupBy === 'manufacturer') {
                        groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
                    } else if (groupBy === 'shop') {
                        groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—ä¸æ˜';
                    } else if (groupBy === 'scale') {
                        groupKey = r.scale && r.scale.trim() !== '' ? r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«ä¸æ˜';
                    } else {
                        return;
                    }
                    if (!groupedReservations[groupKey]) {
                        groupedReservations[groupKey] = [];
                    }
                    groupedReservations[groupKey].push(r);
                });
            }

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    // æ—¥ä»˜æœªå®šã‚’æœ€å¾Œã«
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                if (groupBy === 'none') return 0;
                // ãã‚Œä»¥å¤–ã¯ã‚­ãƒ¼ã®æ–‡å­—åˆ—ã§ã‚½ãƒ¼ãƒˆ
                return a.localeCompare(b);
            });


            // ãƒªã‚¹ãƒˆã«æç”»
            sortedGroupKeys.forEach(groupKey => {
                const reservationsInGroup = groupedReservations[groupKey];
                const count = reservationsInGroup.length;
                
                let displayKey = groupKey;
                if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                    const [datePart, titlePart] = groupKey.split(' ');
                    const [year, month] = datePart.split('-');
                    displayKey = `${year}å¹´${month}æœˆ ${titlePart}`;
                }

                const groupContainer = document.createElement('div');
                // ğŸ”½ ä¿®æ­£: ãƒœãƒ¼ãƒ€ãƒ¼ã®è‰²ã‚’fuchsia-600ã«
                groupContainer.className = 'group-summary-item border border-fuchsia-600 dark:border-fuchsia-400 rounded-xl shadow-sm hover:shadow-md transition duration-200';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼
                const header = document.createElement('div');
                // ğŸ”½ ä¿®æ­£1: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚bg-fuchsia-600/text-whiteã«ãªã‚‹ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹ã‚’ä¿®æ­£
                header.className = 'p-3 bg-fuchsia-600 font-bold text-white cursor-pointer flex justify-between items-center rounded-xl transition duration-150 hover:bg-fuchsia-700 dark:hover:bg-fuchsia-700';
                header.innerHTML = `
                    <span class="text-sm md:text-md">${displayKey}</span>
                    <span class="text-sm font-semibold flex items-center">
                        (${count}ä»¶)
                        <i data-lucide="chevron-down" class="summary-chevron w-4 h-4 ml-2 transition-transform duration-200"></i>
                    </span>
                `;
                groupContainer.appendChild(header);

                // ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãƒªã‚¹ãƒˆ
                const figureList = document.createElement('ul');
                // ğŸ”½ ä¿®æ­£: ãƒªã‚¹ãƒˆå†…ã®æ–‡å­—è‰²ã‚’text-gray-900ï¼ˆé»’ã«è¿‘ã„è‰²ï¼‰ã«
                figureList.className = 'p-3 space-y-1 list-disc list-inside text-gray-900 dark:text-gray-300';
                
                // é …ç›®ã‚’è¿½åŠ 
                reservationsInGroup.forEach(r => {
                    const figureItem = document.createElement('li');
                    figureItem.className = 'text-sm cursor-pointer hover:text-fuchsia-600 dark:hover:text-fuchsia-400 transition duration-150 truncate';
                    figureItem.textContent = r.name + (r.scale && r.scale.trim() !== '' ? ` (${r.scale})` : '');
                    
                    // ğŸŒŸ å€‹åˆ¥ãƒ•ã‚£ã‚®ãƒ¥ã‚¢é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©²å½“ã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    const scrollHandler = () => {
                        const targetCard = document.getElementById(`item-${r.id}`);
                        if (targetCard) {
                            // ğŸŒŸ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // ğŸŒŸ ä¸€æ™‚çš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                            targetCard.classList.add('animate-pulse-once');
                            setTimeout(() => {
                                targetCard.classList.remove('animate-pulse-once');
                            }, 2000); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã«åˆã‚ã›ã¦2ç§’å¾Œã«å‰Šé™¤
                        }
                    };
                    figureItem.onclick = scrollHandler;
                    figureList.appendChild(figureItem);
                });

                groupContainer.appendChild(figureList);
                groupSummaryTargetEl.appendChild(groupContainer);
                
                // ğŸŒŸ ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«ã™ã‚‹å‡¦ç†ã«å¤‰æ›´
                const chevron = header.querySelector('.summary-chevron');
                // ğŸ”½ ä¿®æ­£: ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¯ãƒ©ã‚¹æ“ä½œã‚’å…ƒã«æˆ»ã™
                header.onclick = () => {
                    figureList.classList.toggle('hidden');
                    // ãƒªã‚¹ãƒˆã®è¡¨ç¤ºçŠ¶æ…‹ã«åˆã‚ã›ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã®è§’ä¸¸ã¨ã‚·ã‚§ãƒ–ãƒ­ãƒ³ã‚’èª¿æ•´
                    if (figureList.classList.contains('hidden')) {
                         header.classList.add('rounded-xl');
                         header.classList.remove('rounded-t-xl');
                         chevron.style.transform = 'rotate(0deg)';
                    } else {
                         header.classList.remove('rounded-xl');
                         header.classList.add('rounded-t-xl');
                         chevron.style.transform = 'rotate(180deg)';
                    }
                };
            });

            lucide.createIcons();
        };


        /**
         * ğŸŒŸ ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹
         */
        const renderReservationList = (reservationsToRender, listTargetEl, noDataMessageEl, groupBy, viewTitle, showEditAndDelete) => {
            listTargetEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            
            // ãƒ‡ãƒ¼ã‚¿ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            if (reservationsToRender.length === 0) {
                noDataMessageEl.classList.remove('hidden');
                return;
            } else {
                noDataMessageEl.classList.add('hidden');
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯
            let groupedReservations = {};
            if (groupBy === 'none') {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„å ´åˆã¯å…¨ã¦ã‚’ä¸€ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚Œã‚‹
                groupedReservations['ALL'] = reservationsToRender;
            } else {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
                reservationsToRender.forEach(r => {
                    let groupKey;
                    if (groupBy === 'releaseDateMonth') {
                        const date = r.releaseDate;
                        groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                    } else if (groupBy === 'manufacturer') {
                        groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
                    } else if (groupBy === 'shop') {
                        groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—ä¸æ˜';
                    } else if (groupBy === 'scale') {
                        groupKey = r.scale && r.scale.trim() !== '' ? r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«ä¸æ˜';
                    } else {
                        return;
                    }
                    if (!groupedReservations[groupKey]) {
                        groupedReservations[groupKey] = [];
                    }
                    groupedReservations[groupKey].push(r);
                });
            }

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ (releaseDateMonthã‚’å„ªå…ˆã—ã€ãã‚Œä»¥å¤–ã¯ã‚­ãƒ¼ã§ã‚½ãƒ¼ãƒˆ)
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                if (groupBy === 'none') return 0;
                return a.localeCompare(b);
            });

            // ãƒªã‚¹ãƒˆã«æç”»
            sortedGroupKeys.forEach(groupKey => {
                const reservationsInGroup = groupedReservations[groupKey];
                if (groupBy !== 'none') {
                    const groupHeader = document.createElement('h3');
                    let displayKey = groupKey;
                    if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                        const [year, month] = groupKey.split(' ')[0].split('-');
                        displayKey = `${year}å¹´${month}æœˆ ${groupKey.split(' ')[1]}`;
                    }
                    groupHeader.className = 'group-header';
                    groupHeader.innerHTML = `${displayKey} <span class="text-sm ml-2 font-normal">(${reservationsInGroup.length}ä»¶)</span>`;
                    listTargetEl.appendChild(groupHeader);
                }

                // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æç”»
                reservationsInGroup.forEach(r => {
                    listTargetEl.appendChild(createReservationCard(r, viewTitle, showEditAndDelete));
                });
            });

            addEventListeners(); // å‹•çš„è¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
            lucide.createIcons();
        };


        /**
         * äºˆç´„ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚«ãƒ¼ãƒ‰ã®HTMLè¦ç´ ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        const createReservationCard = (reservation, viewTitle, showEditAndDelete) => {
            const imageUrl = reservation.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image';
            const isCompleted = reservation.status === STATUS_COMPLETED;
            const statusColorClass = STATUS_COLORS[reservation.status] || 'bg-gray-100 text-gray-800 border-gray-300';

            const card = document.createElement('div');
            // ğŸ”½ ä¿®æ­£: ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®èƒŒæ™¯è‰²ã‚’ç™½ (#ffffff) ã«å¤‰æ›´ã—ã¦ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ç¢ºä¿ã€‚
            const cardClass = `p-4 border border-gray-200 rounded-xl shadow-md bg-white transition duration-200 flex space-x-4 items-center ${viewTitle === 'äºˆç´„' && isCompleted ? 'opacity-70 bg-gray-50 dark:bg-gray-700' : 'hover:shadow-lg hover:border-fuchsia-300 dark:bg-gray-800 dark:border-gray-700 dark:hover:border-fuchsia-500'}`;
            
            card.className = cardClass;
            // ğŸŒŸ å€‹åˆ¥ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚«ãƒ¼ãƒ‰ã®IDã‚’ä»˜ä¸
            card.id = `item-${reservation.id}`; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆID
            // ğŸ”½ æ–°è¦è¿½åŠ : ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã¨IDã‚’è¿½åŠ 
            card.dataset.docId = reservation.id; // ãƒ‡ãƒ¼ã‚¿IDã‚’è¿½åŠ 
            card.classList.add('figure-card-clickable', 'cursor-pointer'); // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½åŠ 

            const actionButtons = showEditAndDelete ? `
                <div class="flex space-x-2 flex-shrink-0">
                    <button class="edit-btn text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 dark:text-indigo-400 dark:hover:bg-gray-600 transition" data-doc-id="${reservation.id}" aria-label="ç·¨é›†">
                        <i data-lucide="square-pen" class="w-5 h-5"></i>
                    </button>
                    <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:text-red-400 dark:hover:bg-gray-600 transition" data-doc-id="${reservation.id}" data-item-name="${reservation.name}" aria-label="å‰Šé™¤">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            ` : '';

            card.innerHTML = `
                <img src="${imageUrl}" alt="${reservation.name}" class="figure-image figure-image-clickable" loading="lazy">
                
                <div class="flex-grow min-w-0">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1 truncate">${reservation.name}</h3>
                        ${actionButtons}
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-y-1 gap-x-3 text-sm text-gray-600 dark:text-gray-400">
                        ${reservation.releaseDate ? 
                            `<p class="truncate sm:col-span-1">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-500"></i> 
                                ${viewTitle === 'äºˆç´„' ? 'äºˆå®š' : 'å–å¾—'}: <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.releaseDate}</span>
                            </p>` : ''}
                        ${reservation.price > 0 ? 
                            `<p class="truncate sm:col-span-1">
                                <i data-lucide="yen" class="w-4 h-4 mr-2 text-green-500"></i> 
                                ä¾¡æ ¼: <span class="text-gray-900 dark:text-white font-semibold ml-1">${formatCurrency(reservation.price)}</span>
                            </p>` : ''}
                        ${reservation.scale ? 
                            `<p class="truncate sm:col-span-1">
                                <i data-lucide="ruler" class="w-4 h-4 mr-2 text-orange-500"></i> 
                                ã‚¹ã‚±ãƒ¼ãƒ«: <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.scale}</span>
                            </p>` : ''}
                        ${reservation.shop ? 
                            `<p class="truncate sm:col-span-1">
                                <i data-lucide="store" class="w-4 h-4 mr-2 text-pink-500"></i> 
                                åº—èˆ—: <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.shop}</span>
                            </p>` : ''}
                    </div>

                    <div class="mt-3 flex flex-wrap gap-2 items-center">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full border ${statusColorClass}">
                            ${reservation.status}
                        </span>
                    </div>
                </div>
            `;
            return card;
        };


        // ğŸ”½ğŸ”½ğŸ”½ æ–°è¦è¿½åŠ : è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•° ğŸ”½ğŸ”½ğŸ”½

        /**
         * è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å€‹åˆ¥ã®è¡¨ç¤ºã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
         */
        const createDetailItem = (label, value, isFullWidth = false) => {
            const displayValue = value && value.trim() !== '' ? value : 'N/A';
            return `
                <div class="${isFullWidth ? 'sm:col-span-2' : 'sm:col-span-1'}">
                    <p class="text-xs font-medium text-fuchsia-600 dark:text-fuchsia-400 uppercase">${label}</p>
                    <p class="text-base text-gray-800 dark:text-gray-200 font-semibold break-all">${displayValue}</p>
                </div>
            `;
        };

        /**
         * è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         * @param {Object} reservation - è¡¨ç¤ºã™ã‚‹ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãƒ‡ãƒ¼ã‚¿
         */
        const openDetailModal = (reservation) => {
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š (ã‚¢ã‚¤ã‚³ãƒ³ã¯HTMLã§å›ºå®š)
            detailModalTitleEl.innerHTML = `<i data-lucide="info" class="w-7 h-7 mr-2 text-indigo-500"></i> ${reservation.name}`;

            // è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®HTMLã‚’ç”Ÿæˆ
            const contentHtml = `
                ${reservation.imageUrl ? `
                    <div class="text-center mb-4">
                        <img src="${reservation.imageUrl}" alt="${reservation.name}" class="max-h-64 w-auto mx-auto rounded-xl shadow-lg object-contain border border-gray-200 dark:border-gray-600">
                    </div>
                ` : ''}
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                    ${createDetailItem('ãƒ¡ãƒ¼ã‚«ãƒ¼å/ãƒ–ãƒ©ãƒ³ãƒ‰å', reservation.manufacturer)}
                    ${createDetailItem('ã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ±', reservation.scale)}
                    ${createDetailItem('äºˆç´„æ—¥', reservation.reservationDate)}
                    ${createDetailItem('ç™ºå£²/å¼•æ¸¡äºˆå®šæ—¥', reservation.releaseDate)}
                    ${createDetailItem('è³¼å…¥åº—èˆ—/äºˆç´„ã‚µã‚¤ãƒˆ', reservation.shop)}
                    ${createDetailItem('ä¾¡æ ¼ (å††)', formatCurrency(reservation.price))}
                    ${createDetailItem('æ³¨æ–‡ç•ªå·/äºˆç´„ç•ªå·', reservation.orderNumber)}
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    ${createDetailItem('äºˆç´„çŠ¶æ³', reservation.status, true)}
                    ${createDetailItem('å‚™è€ƒæ¬„', reservation.notes, true)}
                </div>
            `;
            
            detailModalContentEl.innerHTML = contentHtml;
            lucide.createIcons();
            detailModal.classList.remove('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢
            document.body.classList.add('overflow-hidden');
        };

        /**
         * è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        const closeDetailModal = () => {
            detailModal.classList.add('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã‚’è§£é™¤
            document.body.classList.remove('overflow-hidden');
        };

        // ğŸ”¼ğŸ”¼ğŸ”¼ æ–°è¦è¿½åŠ : è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•° ğŸ”¼ğŸ”¼ğŸ”¼


        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         * @param {string} docId - ç·¨é›†å¯¾è±¡ã®Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID (æ–°è¦ä½œæˆã®å ´åˆã¯null/undefined)
         */
        const openModal = (docId = null) => {
            form.reset();
            document.getElementById('doc-id').value = docId;

            if (docId) {
                modalTitle.textContent = 'äºˆç´„æƒ…å ±ã‚’ç·¨é›†';
                const reservation = reservations.find(r => r.id === docId);
                if (reservation) {
                    document.getElementById('name').value = reservation.name || '';
                    document.getElementById('imageUrl').value = reservation.imageUrl || '';
                    document.getElementById('manufacturer').value = reservation.manufacturer || '';
                    document.getElementById('scale').value = reservation.scale || '';
                    document.getElementById('reservationDate').value = reservation.reservationDate || '';
                    document.getElementById('releaseDate').value = reservation.releaseDate || '';
                    document.getElementById('shop').value = reservation.shop || '';
                    document.getElementById('price').value = reservation.price || 0;
                    document.getElementById('status').value = reservation.status || 'äºˆç´„æ¸ˆã¿';
                    document.getElementById('orderNumber').value = reservation.orderNumber || '';
                    document.getElementById('notes').value = reservation.notes || '';
                }
            } else {
                modalTitle.textContent = 'æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ';
                // æ–°è¦ä½œæˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                document.getElementById('price').value = 0;
                document.getElementById('status').value = 'äºˆç´„æ¸ˆã¿';
                // äºˆç´„æ—¥ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã«
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reservationDate').value = today;
            }

            modal.classList.remove('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢
            document.body.classList.add('overflow-hidden');
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        const closeModal = () => {
            modal.classList.add('hidden');
            // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤ºæ™‚ã«bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã‚’è§£é™¤
            document.body.classList.remove('overflow-hidden');
        };

        /**
         * ğŸŒŸ ä¿®æ­£: å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ (äºˆç´„ã€æ‰€æŒã€ã‚µãƒãƒªãƒ¼) ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
         */
        const renderAllViews = () => {
            // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const pendingReservations = reservations.filter(r => r.status !== STATUS_COMPLETED && r.status !== STATUS_CANCELLED);
            const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);

            // 2. çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            updateStats(currentView);

            // 3. äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const groupBy = groupBySelect.value;
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('reservations', groupBy);
            renderGroupSummary(
                pendingReservations, 
                groupSummaryListEl, 
                groupBy, 
                'äºˆç´„'
            );
            // ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³äºˆç´„ãƒªã‚¹ãƒˆã®æç”»ã‚’è¿½åŠ 
            renderReservationList(
                pendingReservations,
                reservationListEl,
                noDataMessage,
                groupBy,
                'äºˆç´„',
                true // äºˆç´„ãƒªã‚¹ãƒˆã¯ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            );

            // 4. æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const groupByOwned = groupBySelectOwned.value;
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('owned', groupByOwned);
            renderGroupSummary(
                ownedReservations, 
                groupSummaryListOwnedEl, 
                groupByOwned, 
                'æ‰€æŒ'
            );
            // ğŸ”½ ä¿®æ­£: ãƒ¡ã‚¤ãƒ³æ‰€æŒãƒªã‚¹ãƒˆã®æç”»ã‚’è¿½åŠ 
            renderReservationList(
                ownedReservations,
                ownedListEl,
                noOwnedDataMessage,
                groupByOwned,
                'æ‰€æŒ',
                false // æ‰€æŒãƒªã‚¹ãƒˆã¯ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            );
        };


        /**
         * ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         * @param {'reservations'|'owned'} view - åˆ‡ã‚Šæ›¿ãˆå…ˆã®ãƒ“ãƒ¥ãƒ¼
         * @param {boolean} updateHistory - å±¥æ­´ã‚’æ›´æ–°ã™ã‚‹ã‹ã©ã†ã‹
         */
        const switchTab = (view, updateHistory = true) => {
            // 1. ã‚¯ãƒ©ã‚¹ã®å®šç¾©ã‚’å†åˆ©ç”¨
            const reservationsBtn = document.getElementById('tab-reservations');
            const ownedBtn = document.getElementById('tab-owned');
            const fixedReservationsBtn = document.getElementById('fixed-summary-btn-reservations');
            const fixedOwnedBtn = document.getElementById('fixed-summary-btn-owned');
            const mobileAddBtn = document.getElementById('open-modal-btn-mobile');

            // 2. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
            if (view === 'reservations') {
                reservationsBtn.classList.add(...ACTIVE_CLASSES);
                reservationsBtn.classList.remove(...INACTIVE_CLASSES);
                ownedBtn.classList.add(...INACTIVE_CLASSES);
                ownedBtn.classList.remove(...ACTIVE_CLASSES);

                // 3. ãƒšãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆ
                reservationsPage.classList.remove('hidden');
                ownedPage.classList.add('hidden');
                currentView = 'reservations';
                // ğŸ”½ ä¿®æ­£: å›ºå®šãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆã¨ãƒ¢ãƒã‚¤ãƒ«äºˆç´„è¿½åŠ ãƒœã‚¿ãƒ³ã®è¡¨ç¤º
                if (fixedReservationsBtn && fixedOwnedBtn && mobileAddBtn) {
                    fixedReservationsBtn.classList.remove('hidden');
                    fixedOwnedBtn.classList.add('hidden');
                    mobileAddBtn.classList.remove('hidden'); // äºˆç´„ãƒ“ãƒ¥ãƒ¼ã§ã®ã¿è¡¨ç¤º
                }

            } else if (view === 'owned') {
                ownedBtn.classList.add(...ACTIVE_CLASSES);
                ownedBtn.classList.remove(...INACTIVE_CLASSES);
                reservationsBtn.classList.add(...INACTIVE_CLASSES);
                reservationsBtn.classList.remove(...ACTIVE_CLASSES);

                // 3. ãƒšãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆ
                reservationsPage.classList.add('hidden');
                ownedPage.classList.remove('hidden');
                currentView = 'owned';
                // ğŸ”½ ä¿®æ­£: å›ºå®šãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆã¨ãƒ¢ãƒã‚¤ãƒ«äºˆç´„è¿½åŠ ãƒœã‚¿ãƒ³ã®éè¡¨ç¤º
                if (fixedReservationsBtn && fixedOwnedBtn && mobileAddBtn) {
                    fixedReservationsBtn.classList.add('hidden');
                    fixedOwnedBtn.classList.remove('hidden');
                    mobileAddBtn.classList.add('hidden'); // æ‰€æŒãƒ“ãƒ¥ãƒ¼ã§ã¯éè¡¨ç¤º
                }
            } else {
                return; // ç„¡åŠ¹ãªãƒ“ãƒ¥ãƒ¼
            }

            // 4. çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            updateStats(currentView);

            // 5. å±¥æ­´ã®æ›´æ–° (å¾Œæ–¹ãƒœã‚¿ãƒ³å¯¾å¿œ)
            if (updateHistory) {
                history.pushState({ view: currentView }, '', `#${currentView}`);
            }

            // ğŸŒŸ ä¿®æ­£: ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const groupBySelectEl = view === 'reservations' ? groupBySelect : groupBySelectOwned;
            updateSummaryTitle(view, groupBySelectEl.value);

            // ğŸŒŸ ä¿®æ­£: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ)
            closeSidebar(view === 'reservations' ? 'owned' : 'reservations'); // å¿µã®ãŸã‚åå¯¾å´ã‚’é–‰ã˜ã‚‹
            closeSidebar(view); // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
            
            // ğŸŒŸ ä¿®æ­£: ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ—¢ã«renderAllViewsã§å…¨ã¦å‡¦ç†ã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚ï¼‰
            // renderAllViews(); // onSnapshotãŒå‘¼ã¶ãŸã‚ã€ã“ã“ã§ã¯å†—é•·ã«ãªã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚
        };

        /**
         * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹
         */
        const toggleDarkMode = () => {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            // ã‚¢ã‚¤ã‚³ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ (æœˆ/å¤ªé™½)
            const iconEl = toggleDarkModeBtn.querySelector('i');
            if (isDarkMode) {
                iconEl.setAttribute('data-lucide', 'sun');
            } else {
                iconEl.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³ã®å†æç”»
        };

        /**
         * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹
         */
        const initializeDarkMode = () => {
            const darkModeState = localStorage.getItem('darkMode');
            if (darkModeState === 'enabled' || (!darkModeState && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤ªé™½ã«ã™ã‚‹
                const iconEl = toggleDarkModeBtn.querySelector('i');
                iconEl.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        };

        /**
         * ã‚µã‚¤ãƒ‰ãƒãƒ¼ (ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼) ã‚’é–‹é–‰ã™ã‚‹
         * @param {'reservations'|'owned'} view - å¯¾è±¡ã®ãƒ“ãƒ¥ãƒ¼
         * @param {boolean} open - trueã§é–‹ã, falseã§é–‰ã˜ã‚‹
         */
        const toggleSidebar = (view, open) => {
            const sidebarEl = view === 'reservations' ? sidebarReservationsEl : sidebarOwnedEl;
            const overlayEl = view === 'reservations' ? sidebarOverlayReservations : sidebarOverlayOwned;
            const openBtn = view === 'reservations' ? openSummaryBtnReservations : openSummaryBtnOwned;
            
            if (open) {
                sidebarEl.classList.remove('-translate-x-full');
                overlayEl.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                sidebarEl.classList.add('-translate-x-full');
                overlayEl.classList.add('hidden');
                // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã‘ã‚Œã°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã‚’è§£é™¤
                if (modal.classList.contains('hidden') && detailModal.classList.contains('hidden')) {
                     document.body.classList.remove('overflow-hidden');
                }
            }
        };

        const openSidebar = (view) => toggleSidebar(view, true);
        const closeSidebar = (view) => toggleSidebar(view, false);


        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (renderAllViewsã‚’å‘¼ã¶ã‚ˆã†ã«å¤‰æ›´)
        const setupFirestoreListener = () => {
            const q = query(collection(db, COLLECTION_NAME), orderBy('releaseDate', 'asc'));

            // onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ç›£è¦–
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                loadingIndicator.classList.remove('hidden');
                loadingIndicatorOwned.classList.remove('hidden');
                
                const newReservations = [];
                querySnapshot.forEach((doc) => {
                    newReservations.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                reservations = newReservations; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªreservationsã‚’æ›´æ–°

                renderAllViews();
                
            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ", error);
                loadingIndicator.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                loadingIndicator.classList.remove('hidden');
            });
            return unsubscribe;
        };


        /**
         * ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜ã™ã‚‹ (æ–°è¦ä½œæˆã¾ãŸã¯æ›´æ–°)
         */
        const saveReservation = async (e) => {
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');

            const docId = document.getElementById('doc-id').value;
            const name = document.getElementById('name').value.trim();
            const imageUrl = document.getElementById('imageUrl').value.trim();
            const manufacturer = document.getElementById('manufacturer').value.trim();
            const scale = document.getElementById('scale').value.trim();
            const reservationDate = document.getElementById('reservationDate').value;
            const releaseDate = document.getElementById('releaseDate').value;
            const shop = document.getElementById('shop').value.trim();
            const price = parseInt(document.getElementById('price').value) || 0;
            const status = document.getElementById('status').value;
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const notes = document.getElementById('notes').value.trim();

            const data = {
                name,
                imageUrl,
                manufacturer,
                scale,
                reservationDate,
                releaseDate,
                shop,
                price,
                status,
                orderNumber,
                notes,
                updatedAt: serverTimestamp()
            };

            try {
                if (docId) {
                    // ç·¨é›†
                    await setDoc(doc(db, COLLECTION_NAME, docId), data, { merge: true });
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:", docId);
                } else {
                    // æ–°è¦ä½œæˆ
                    await addDoc(collection(db, COLLECTION_NAME), {
                        ...data,
                        createdAt: serverTimestamp()
                    });
                    console.log("æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
                }
                closeModal();
            } catch (error) {
                console.error("äºˆç´„ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };

        // äºˆç´„ã®å‰Šé™¤ (å¤‰æ›´ãªã—)
        const deleteReservation = async () => {
            if (!docIdToDelete) return;
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');

            try {
                await deleteDoc(doc(db, COLLECTION_NAME, docIdToDelete));
                console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ:", docIdToDelete);
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            } catch (error) {
                console.error("äºˆç´„ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };


        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ  (ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«å†è¿½åŠ )
        const addEventListeners = () => {
            // ç·¨é›†ãƒœã‚¿ãƒ³
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
                    openModal(button.dataset.docId);
                };
            });

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
                    docIdToDelete = button.dataset.docId;
                    deleteItemNameEl.textContent = button.dataset.itemName;
                    deleteModal.classList.remove('hidden');
                };
            });

            // ğŸŒŸ ğŸ”½ æ–°è¦è¿½åŠ : ãƒ•ã‚£ã‚®ãƒ¥ã‚¢è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('.figure-card-clickable').forEach(card => {
                card.onclick = (e) => {
                    // ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯è©³ç´°è¡¨ç¤ºã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
                    if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) {
                        return;
                    }

                    const docId = card.dataset.docId;
                    const reservation = reservations.find(r => r.id === docId);
                    if (reservation) {
                        openDetailModal(reservation);
                    }
                };
            });
        };


        // åˆæœŸåŒ–å‡¦ç†
        const init = async () => {
            initializeDarkMode();

            // Firebaseæ¥ç¶šã‚’è©¦ã¿ã‚‹
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // åŒ¿åèªè¨¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ (èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸)
                await signInAnonymously(auth);

                authInfoEl.innerHTML = `<i data-lucide="cloud-check" class="w-5 h-5 mr-3 inline-block"></i>ã€æ¥ç¶šæ¸ˆã¿ã€‘Firebase Firestoreã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚`;
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-green-100', 'border-green-500', 'text-green-800');

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupFirestoreListener();

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯æ¥ç¶šã‚¨ãƒ©ãƒ¼:", error);
                authInfoEl.innerHTML = `<i data-lucide="cloud-off" class="w-5 h-5 mr-3 inline-block"></i>ã€æ¥ç¶šå¤±æ•—ã€‘Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            }

            // ğŸŒŸ 1. ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ã‚¤ãƒ™ãƒ³ãƒˆ
            if (openModalBtnDesktop) openModalBtnDesktop.onclick = () => openModal();
            if (openModalBtnMobile) openModalBtnMobile.onclick = () => openModal();
            if (closeModalBtn) closeModalBtn.onclick = closeModal;
            if (modalCloseIcon) modalCloseIcon.onclick = closeModal;
            // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«é–‰ã˜ã‚‹
            if (modal) modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            };
            
            // ğŸŒŸ ğŸ”½ æ–°è¦è¿½åŠ : è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (closeDetailModalBtn) closeDetailModalBtn.onclick = closeDetailModal;
            if (detailModalCloseIcon) detailModalCloseIcon.onclick = closeDetailModal;
            if (detailModal) detailModal.onclick = (e) => {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«é–‰ã˜ã‚‹
                if (e.target === detailModal) {
                    closeDetailModal();
                }
            };


            // ğŸŒŸ 2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            if (form) form.onsubmit = saveReservation;

            // ğŸŒŸ 3. å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            if (cancelDeleteBtn) cancelDeleteBtn.onclick = () => deleteModal.classList.add('hidden');
            if (confirmDeleteBtn) confirmDeleteBtn.onclick = deleteReservation;
            if (deleteModal) deleteModal.onclick = (e) => {
                if (e.target === deleteModal) {
                    deleteModal.classList.add('hidden');
                }
            };

            // ğŸŒŸ 4. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«
            if (toggleDarkModeBtn) {
                toggleDarkModeBtn.onclick = toggleDarkMode;
            }
            
            // ğŸŒŸ 5. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (tabReservationsBtn) tabReservationsBtn.onclick = () => switchTab('reservations');
            if (tabOwnedBtn) tabOwnedBtn.onclick = () => switchTab('owned');
            
            // ğŸŒŸ 6. ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (groupBySelect) {
                groupBySelect.onchange = () => {
                    if (currentView === 'reservations') {
                        renderAllViews();
                    }
                };
            }
            
            // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (groupBySelectOwned) {
                groupBySelectOwned.onchange = () => {
                    if (currentView === 'owned') {
                        renderAllViews();
                    }
                };
            }
            
            // ğŸŒŸ 7. è¿½åŠ : ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (fixedãƒœã‚¿ãƒ³ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å¤‰æ•°ã¯æ—¢ã«æ›´æ–°æ¸ˆã¿)
            // äºˆç´„ãƒ“ãƒ¥ãƒ¼
            if (openSummaryBtnReservations) openSummaryBtnReservations.onclick = () => openSidebar('reservations'); // fixed-summary-btn-reservations ã«æ¥ç¶š
            if (closeSummaryBtnReservations) closeSummaryBtnReservations.onclick = () => closeSidebar('reservations');
            if (sidebarOverlayReservations) sidebarOverlayReservations.onclick = () => closeSidebar('reservations');

            // æ‰€æŒãƒ“ãƒ¥ãƒ¼
            if (openSummaryBtnOwned) openSummaryBtnOwned.onclick = () => openSidebar('owned'); // fixed-summary-btn-owned ã«æ¥ç¶š
            if (closeSummaryBtnOwned) closeSummaryBtnOwned.onclick = () => closeSidebar('owned');
            if (sidebarOverlayOwned) sidebarOverlayOwned.onclick = () => closeSidebar('owned');

            // ğŸŒŸ 8. å±¥æ­´APIã«ã‚ˆã‚‹ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®åˆæœŸåŒ–
            const initialView = window.location.hash.substring(1) || 'reservations';
            switchTab(initialView, false); // å±¥æ­´ã‚’æ›´æ–°ã›ãšã«åˆæœŸåŒ–

            // ğŸŒŸ 9. ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³å¯¾å¿œ
            window.onpopstate = (event) => {
                const view = event.state && event.state.view ? event.state.view : 'reservations';
                switchTab(view, false);
            };

            // ğŸŒŸ 10. åˆæœŸã‚¢ã‚¤ã‚³ãƒ³æç”»
            lucide.createIcons();
        };

        init();

    </script>
</body>
</html>