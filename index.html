<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* === ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ === */
        body {
            font-family: 'Inter', sans-serif;
            /* èƒŒæ™¯è‰²ã¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ */
            background: linear-gradient(135deg, #e0f7fa 0%, #f9f0ff 100%);
            color: #1f2937; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆè‰² */
            transition: background-color 0.3s, color 0.3s;
            /* ğŸ”½ ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºãŒä¸»ï¼‰ */
            font-size: 0.95rem;
        }
        
        /* ğŸ”½ ä¿®æ­£: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§æ¨™æº–ã‚µã‚¤ã‚ºã«æˆ»ã™ */
        @media (min-width: 768px) {
            body {
                font-size: 1rem;
            }
        }
        
        .bg-white { background-color: white !important; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important; }

        /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        .dark body {
            background: #1f2937; /* æš—ã„èƒŒæ™¯ */
            color: #f3f4f6; /* æ˜ã‚‹ã„ãƒ†ã‚­ã‚¹ãƒˆ */
        }

        /* ğŸ”½ ã“ã“ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚«ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã§ã™ (æ¿ƒã„ã‚°ãƒ¬ãƒ¼) */
        .dark .bg-white {
            background-color: #374151 !important; /* æš—ã‚ã®ã‚°ãƒ¬ãƒ¼ */
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
        .dark .shadow-2xl { 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important; 
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰² */
        .dark .group-header {
            background-color: #6d28d9; /* æ¿ƒã„ã‚ã®ç´« */
            color: #f3f4f6;
        }
        
        /* ğŸ”½ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®èƒŒæ™¯è‰² */
        .dark .bg-fuchsia-50 { background-color: #4c1d95 !important; color: #e5e7eb !important; } 
        .dark .bg-fuchsia-100 { background-color: #5b21b6 !important; }
        .dark .hover\:bg-fuchsia-200:hover { background-color: #6d28d9 !important; }
        .dark .text-fuchsia-700 { color: #f0abfc !important; } 
        .dark .border-fuchsia-400 { border-color: #a78bfa !important; }


        /* ğŸ”½ ã“ã“ã§ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç™½è‰²ç³»çµ±ã«ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ */
        .dark input, .dark select {
            background-color: #4b5563; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            color: #f3f4f6; /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
            border-color: #6b7280;
        }
        
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .text-gray-900 { color: #f3f4f6 !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-800 { color: #f3f4f6 !important; } /* ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã¨äºˆç´„ãƒªã‚¹ãƒˆã®H2ã‚¿ã‚°ãªã©ã«å¯¾å¿œ */
        .dark .text-gray-700 { color: #e5e7eb !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-600 { color: #d1d5db !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */
        .dark .text-gray-500 { color: #9ca3af !important; } /* ç™½ç³»çµ±ã®æ–‡å­— (OK) */

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        .dark .reservation-list::-webkit-scrollbar-thumb {
            background-color: #8b5cf6; 
        }
        .dark .reservation-list::-webkit-scrollbar-track {
            background: #4b5563;
        }

        .reservation-list {
            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã€æœ€å¤§é«˜ã•ã‚’è¨­å®š */
            min-height: 70vh;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ  */
        .reservation-list::-webkit-scrollbar {
            width: 8px;
        }
        .reservation-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* ç´«ç³»ã®ã‚µãƒ ãƒã‚¤ãƒ« */
            border-radius: 10px;
        }
        .reservation-list::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        /* ç”»åƒã‚’ã‚«ãƒ¼ãƒ‰ã«åã‚ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .figure-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0; /* ç”»åƒãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        
        /* ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .group-header {
            background-color: #8b5cf6; /* ç´«è‰² */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰ (ğŸŒŸ è¿½åŠ ) */
        @keyframes pulse-once {
          0% { background-color: #8b5cf6; }
          50% { background-color: #a78bfa; }
          100% { background-color: #8b5cf6; }
        }
        .animate-pulse-once {
            animation: pulse-once 2s ease-out;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <div class="flex justify-between items-start mb-8">
            <h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 flex items-center">
                <i data-lucide="sparkles" class="w-8 h-8 mr-3 text-fuchsia-600"></i>
                ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
            </h1>
            <button id="toggle-dark-mode" class="p-3 rounded-full text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition duration-300 transform hover:scale-110">
                <i data-lucide="moon" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="mb-8">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-reservations" data-tab="reservations" class="tab-button py-3 px-1 border-b-2 font-medium text-lg whitespace-nowrap transition duration-200 border-fuchsia-500 text-fuchsia-600 dark:text-fuchsia-400">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-2 inline-block"></i>
                        äºˆç´„ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ (æœªå®Œäº†)
                    </button>
                    <button id="tab-owned" data-tab="owned" class="tab-button py-3 px-1 border-b-2 font-medium text-lg whitespace-nowrap transition duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500">
                        <i data-lucide="archive" class="w-5 h-5 mr-2 inline-block"></i>
                        æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ (å®Œäº†)
                    </button>
                </nav>
            </div>
        </div>
        <div id="auth-info-firebase" class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-xl shadow-lg text-sm text-yellow-800 font-semibold flex items-center">
            <i data-lucide="cloud-off" class="w-5 h-5 mr-3 inline-block"></i>
            ã€æœªæ¥ç¶šã€‘`firebaseConfig`ã‚’è¨­å®šã—ã¦ã€Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚
        </div>

        <div id="stats" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            </div>

        <div id="tab-content-container">

            <div id="page-reservations" class="tab-page">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <button id="open-modal-btn" class="w-full md:w-auto px-8 py-3 bg-fuchsia-600 text-white font-bold rounded-full shadow-xl hover:bg-fuchsia-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                        æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ 
                    </button>
                    <div class="flex items-center space-x-3">
                        <label for="group-by-select" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">ç™ºå£²æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>

                <div id="main-content-wrapper-reservations" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar" class="md:col-span-3 bg-white p-6 rounded-3xl shadow-2xl border border-gray-100 md:h-fit md:sticky md:top-4">
                        <h2 id="summary-title-reservations" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                äºˆç´„ãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="reservation-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>ä¸Šã®ã€Œæ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-owned" class="tab-page hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <div class="flex-grow"></div> <div class="flex items-center space-x-3">
                        <label for="group-by-select-owned" class="text-gray-700 font-medium whitespace-nowrap">è¡¨ç¤ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–:</label>
                        <select id="group-by-select-owned" class="p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none bg-white">
                            <option value="none">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãªã„</option>
                            <option value="releaseDateMonth">è³¼å…¥/å—å–æœˆ</option>
                            <option value="manufacturer">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
                            <option value="shop">è³¼å…¥åº—èˆ—</option>
                            <option value="scale">ã‚¹ã‚±ãƒ¼ãƒ«</option>
                        </select>
                    </div>
                </div>
                <div id="main-content-wrapper-owned" class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <div id="group-summary-sidebar-owned" class="md:col-span-3 bg-white p-6 rounded-3xl shadow-2xl border border-gray-100 md:h-fit md:sticky md:top-4">
                        <h2 id="summary-title-owned" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                            æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ ã‚µãƒãƒªãƒ¼
                        </h2>
                        <div id="group-summary-list-owned" class="space-y-2">
                            <p class="text-gray-500 text-sm">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                    </div>
                    
                    <div class="md:col-span-9">
                        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-100">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                                <i data-lucide="archive" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãƒªã‚¹ãƒˆ
                            </h2>
                            
                            <div id="loading-indicator-owned" class="text-center py-12 text-gray-500 hidden">
                                <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mx-auto mb-3 text-indigo-500"></i>
                                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
                            </div>

                            <div id="owned-list" class="reservation-list space-y-5">
                            </div>

                            <div id="no-owned-data-message" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="info" class="w-8 h-8 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">ç¾åœ¨ã€å—ã‘å–ã‚Šæ¸ˆã¿ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                <p>äºˆç´„ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†ã€ã«æ›´æ–°ã—ã¦ãã ã•ã„ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        </div>

    <div id="reservation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-8 relative transform transition-all duration-300">
            <h2 id="modal-title" class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ </h2>
            
            <form id="reservation-form" class="space-y-5">
                <input type="hidden" id="doc-id">

                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å <span class="text-red-500">*</span></label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>
                
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700">ç”»åƒURL</label>
                    <input type="url" id="imageUrl" placeholder="http://..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="manufacturer" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ã‚«ãƒ¼å/ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
                        <input type="text" id="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="scale" class="block text-sm font-medium text-gray-700">ã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ± (ä¾‹: 1/7, HG)</label>
                        <input type="text" id="scale" placeholder="ä¾‹: 1/7" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="reservationDate" class="block text-sm font-medium text-gray-700">äºˆç´„æ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="reservationDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                    <div>
                        <label for="releaseDate" class="block text-sm font-medium text-gray-700">ç™ºå£²/å¼•æ¸¡äºˆå®šæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="releaseDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="shop" class="block text-sm font-medium text-gray-700">è³¼å…¥åº—èˆ—/äºˆç´„ã‚µã‚¤ãƒˆ</label>
                        <input type="text" id="shop" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">ä¾¡æ ¼ (å††)</label>
                        <input type="number" id="price" min="0" value="0" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">äºˆç´„çŠ¶æ³ <span class="text-red-500">*</span></label>
                    <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 appearance-none transition duration-150 bg-white">
                        <option value="äºˆç´„æ¸ˆã¿">äºˆç´„æ¸ˆã¿</option>
                        <option value="æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰">æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰</option>
                        <option value="ç™ºé€é€£çµ¡å¾…ã¡">ç™ºé€é€£çµ¡å¾…ã¡</option>
                        <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        <option value="å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†">å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="orderNumber" class="block text-sm font-medium text-gray-700">æ³¨æ–‡ç•ªå·/äºˆç´„ç•ªå·</label>
                        <input type="text" id="orderNumber" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">å‚™è€ƒæ¬„</label>
                        <input type="text" id="notes" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition duration-150">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-5">
                    <button type="button" id="close-modal-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150 font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-8 py-2 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-105">ä¿å­˜</button>
                </div>
            </form>
            <button id="modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold text-red-600 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                å‰Šé™¤ã®ç¢ºèª
            </h3>
            <p class="text-gray-700">æœ¬å½“ã«ã“ã®äºˆç´„æƒ…å ±ï¼ˆ<span id="delete-item-name" class="font-bold"></span>ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="confirm-delete-btn" class="px-8 py-2 bg-red-600 text-white font-bold rounded-full shadow-md hover:bg-red-700 transition duration-150">å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰
        setLogLevel('Debug');
        
        // =========================================================
        // ğŸš¨ ã€é‡è¦ã€‘ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // (æ·»ä»˜ã‚³ãƒ¼ãƒ‰ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™)
        // =========================================================
    	const firebaseConfig = {
  		apiKey: "AIzaSyD9jmIafM4JjpJyv65WjFWlbV_n9dssUt4",
  		authDomain: "figure-manager-app.firebaseapp.com",
  		projectId: "figure-manager-app",
  		storageBucket: "figure-manager-app.firebasestorage.app",
  		messagingSenderId: "487492839040",
  		appId: "1:487492839040:web:a43419d861335f259da865",
  		measurementId: "G-19FTK3XTW4"
	};
        // =========================================================
        // ğŸš¨ ã“ã“ã‹ã‚‰ä¸‹ã¯ç·¨é›†ã—ãªã„ã§ãã ã•ã„
        // =========================================================

        let db, auth;
        let reservations = [];
        const COLLECTION_NAME = 'figure_reservations_data'; 

        // DOMè¦ç´ ã®å–å¾—
        const reservationListEl = document.getElementById('reservation-list');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');
        const modal = document.getElementById('reservation-modal');
        const form = document.getElementById('reservation-form');
        const modalTitle = document.getElementById('modal-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');
        const statsEl = document.getElementById('stats');
        const authInfoEl = document.getElementById('auth-info-firebase');
        const groupBySelect = document.getElementById('group-by-select'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿
        const groupSummaryListEl = document.getElementById('group-summary-list'); // äºˆç´„ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼è¦ç´ 
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteItemNameEl = document.getElementById('delete-item-name');
        let docIdToDelete = null;

        // ğŸŒŸ æ–°è¦è¿½åŠ ã•ã‚ŒãŸDOMè¦ç´ ã¨çŠ¶æ…‹å¤‰æ•°
        const tabReservationsBtn = document.getElementById('tab-reservations');
        const tabOwnedBtn = document.getElementById('tab-owned');
        const pageReservationsEl = document.getElementById('page-reservations');
        const pageOwnedEl = document.getElementById('page-owned');
        const ownedListEl = document.getElementById('owned-list');
        const groupSummaryListOwnedEl = document.getElementById('group-summary-list-owned');
        const noOwnedDataMessage = document.getElementById('no-owned-data-message');
        const loadingIndicatorOwned = document.getElementById('loading-indicator-owned');
        
        // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚·ãƒ¼ãƒˆç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã‚’è¿½åŠ 
        const groupBySelectOwned = document.getElementById('group-by-select-owned');
        
        // ğŸ”½ æ–°è¦è¿½åŠ : ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ 
        const summaryTitleReservationsEl = document.getElementById('summary-title-reservations');
        const summaryTitleOwnedEl = document.getElementById('summary-title-owned');

        let currentView = 'reservations'; // 'reservations' or 'owned'

        // äºˆç´„çŠ¶æ³ã®ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
        const STATUS_COLORS = {
            'äºˆç´„æ¸ˆã¿': 'bg-blue-200 text-blue-800 border-blue-300',
            'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰': 'bg-amber-200 text-amber-800 border-amber-300',
            'ç™ºé€é€£çµ¡å¾…ã¡': 'bg-purple-200 text-purple-800 border-purple-300',
            'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 'bg-gray-200 text-gray-500 border-gray-300',
            'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†': 'bg-green-200 text-green-800 border-green-300'
        };
        
        const STATUS_COMPLETED = 'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†';
        const STATUS_CANCELLED = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        
        // ğŸ”½ å¤‰æ›´: ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚­ãƒ¼ã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰ã€Œã”ã¨ã€ã¨ã€Œã‚µãƒãƒªãƒ¼ã€ã‚’å‰Šé™¤
        const GROUP_BY_NAMES = {
            'none': 'å…¨ã¦', // ã€Œã‚°ãƒ«ãƒ¼ãƒ—ã€ã‹ã‚‰ã€Œå…¨ã‚¢ã‚¤ãƒ†ãƒ ã€ã«å¤‰æ›´
            // äºˆç´„ãƒªã‚¹ãƒˆå´
            'releaseDateMonth': 'ç™ºå£²æœˆ', // ã”ã¨ã¨ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤
            'manufacturer': 'ãƒ¡ãƒ¼ã‚«ãƒ¼', // ã”ã¨ã¨ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤
            'shop': 'è³¼å…¥åº—èˆ—', // ã”ã¨ã¨ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤
            'scale': 'ã‚¹ã‚±ãƒ¼ãƒ«', // ã”ã¨ã¨ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤
        };

        /**
         * ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚­ãƒ¼ã‚’æ—¥æœ¬èªã®è¡¨ç¤ºåã«å¤‰æ›ã™ã‚‹
         */
        const getGroupByDisplayName = (groupBy) => {
            return GROUP_BY_NAMES[groupBy] || GROUP_BY_NAMES['none'];
        };

        /**
         * ğŸŒŸ ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
         */
        const updateSummaryTitle = (view, groupBy) => {
            const titleEl = view === 'reservations' ? summaryTitleReservationsEl : summaryTitleOwnedEl;
            if (!titleEl) return;
            
            // ğŸ”½ å¤‰æ›´: ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºåã‚’å–å¾—ã—ã€æœ«å°¾ã«ã€Œã‚µãƒãƒªãƒ¼ã€ã‚’ä»˜ã‘ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
            const baseName = GROUP_BY_NAMES[groupBy] || GROUP_BY_NAMES['none'];
            
            // ğŸ”½ å¤‰æ›´: æ‰€æŒãƒ“ãƒ¥ãƒ¼ã§ã‚‚ãã®ã¾ã¾ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’è¡¨ç¤ºï¼ˆã€Œæ‰€æŒã€ã¯å«ã‚ãªã„ï¼‰
            const newTitleText = baseName; // ã€Œã‚µãƒãƒªãƒ¼ã€è¡¨è¨˜ã‚’å‰Šé™¤
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã¨æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’innerHTMLã§å†æ§‹ç¯‰
            titleEl.innerHTML = `
                <i data-lucide="layers" class="w-5 h-5 mr-2 text-fuchsia-500"></i>
                ${newTitleText}
            `;
            lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³ãŒå†æç”»ã•ã‚Œã‚‹ã‚ˆã†ã«
        };
        
        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–° (å¤‰æ›´: viewå¼•æ•°ã‚’å—ã‘å–ã‚Šã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†å²)
        const updateStats = (view) => {
        // ... (çœç•¥: çµ±è¨ˆæƒ…å ±ã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            if (reservations.length === 0) {
                statsEl.innerHTML = '';
                return;
            }

            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            const formatCurrency = (amount) => {
                return amount.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' });
            };

            if (view === 'reservations') {
                // --- äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯) ---
                let totalReserved = 0;
                let upcomingPaymentTotal = 0;
                let pendingReservations = 0;

                reservations.forEach(r => {
                    const price = r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null;
                    const status = r.status;

                    // æ”¯æ‰•ã„äºˆå®šç·é¡ã®è¨ˆç®— (å—ã‘å–ã‚Šæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–)
                    if (status !== STATUS_COMPLETED && status !== STATUS_CANCELLED) {
                        totalReserved += price;
                    }

                    // ä»Šæœˆãƒ»æ¥æœˆç™ºå£²äºˆå®šã®æ”¯æ‰•ã„åˆè¨ˆ (ã¾ã å—ã‘å–ã£ã¦ãªã„ã‚‚ã®)
                    if (releaseDate && status !== STATUS_COMPLETED && status !== STATUS_CANCELLED) {
                        const releaseMonth = releaseDate.getMonth();
                        const releaseYear = releaseDate.getFullYear();
                        
                        const nextMonthDate = new Date();
                        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                        const nextMonth = nextMonthDate.getMonth();
                        const nextMonthYear = nextMonthDate.getFullYear();

                        const isThisMonth = releaseYear === thisYear && releaseMonth === thisMonth;
                        const isNextMonth = releaseYear === nextMonthYear && releaseMonth === nextMonth;
                        
                        if (isThisMonth || isNextMonth) {
                            upcomingPaymentTotal += price;
                        }
                    }

                    // æœªå®Œäº†ã®äºˆç´„ä»¶æ•°
                    if (status === 'äºˆç´„æ¸ˆã¿' || status === 'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰' || status === 'ç™ºé€é€£çµ¡å¾…ã¡') {
                        pendingReservations++;
                    }
                });

                const totalReservations = reservations.length;
                
                statsEl.innerHTML = `
                    ${createStatCard('äºˆç´„ç·ä»¶æ•° (å…¨ãƒ‡ãƒ¼ã‚¿)', totalReservations, 'list-ordered', 'text-indigo-600')}
                    ${createStatCard('æœªå®Œäº†ä»¶æ•°', pendingReservations, 'package-search', 'text-fuchsia-600')}
                    ${createStatCard('æ”¯æ‰•ã„äºˆå®šç·é¡', formatCurrency(totalReserved), 'circle-yen', 'text-green-600')}
                    ${createStatCard('ä»Šæœˆãƒ»æ¥æœˆæ”¯æ‰•äºˆå®šé¡', formatCurrency(upcomingPaymentTotal), 'calendar-check', 'text-amber-600')}
                `;

            } else if (view === 'owned') {
                // --- æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®çµ±è¨ˆ (æ–°è¦ãƒ­ã‚¸ãƒƒã‚¯) ---
                const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);
                let totalOwnedPrice = 0;
                let thisYearOwnedCount = 0;

                ownedReservations.forEach(r => {
                    totalOwnedPrice += r.price || 0;
                    const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null;

                    if (releaseDate && releaseDate.getFullYear() === thisYear) {
                        thisYearOwnedCount++;
                    }
                });
                
                const totalOwnedCount = ownedReservations.length;

                // æ‰€æŒãƒ“ãƒ¥ãƒ¼ç”¨ã®çµ±è¨ˆã‚«ãƒ¼ãƒ‰
                statsEl.innerHTML = `
                    ${createStatCard('æ‰€æŒç·ä»¶æ•°', totalOwnedCount, 'archive', 'text-indigo-600')}
                    ${createStatCard('æœ¬å¹´å–å¾—ä»¶æ•°', thisYearOwnedCount, 'trending-up', 'text-fuchsia-600')}
                    ${createStatCard('ç·è³¼å…¥é¡', formatCurrency(totalOwnedPrice), 'circle-yen', 'text-green-600')}
                    ${createStatCard('å¹³å‡å˜ä¾¡', totalOwnedCount > 0 ? formatCurrency(Math.round(totalOwnedPrice / totalOwnedCount)) : formatCurrency(0), 'scale', 'text-amber-600')}
                `;
            }

            lucide.createIcons();
        };

        /**
         * çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        const createStatCard = (title, value, iconName, colorClass) => {
        // ... (çœç•¥: çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            return `
                <div class="bg-white p-5 rounded-3xl shadow-lg border border-gray-100 dark:bg-gray-700 dark:border-gray-600">
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${title}</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">${value}</p>
                        </div>
                        <div class="${colorClass} bg-gray-50 p-3 rounded-full">
                            <i data-lucide="${iconName}" class="w-7 h-7"></i>
                        </div>
                    </div>
                </div>
            `;
        };

        /**
         * ğŸŒŸ æ±ç”¨çš„ãªã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼æç”»é–¢æ•° (å¤‰æ›´: ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª¿æ•´)
         */
        const renderGroupSummary = (
            reservationsToRender, 
            groupSummaryTargetEl, 
            groupBy, 
            viewTitle
        ) => {
            groupSummaryTargetEl.innerHTML = '';

            if (reservationsToRender.length === 0) {
                groupSummaryTargetEl.innerHTML = `<p class="text-gray-500 text-sm">${viewTitle}æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            // --- ğŸ”½ ä¿®æ­£: groupBy === 'none' ã®å ´åˆã‚‚ã€ãƒˆã‚°ãƒ«å¯èƒ½ãªã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã¨ã—ã¦å‡¦ç† ğŸ”½ ---
            let groupedReservations = {};
            if (groupBy === 'none') {
                // 'none'ã®å ´åˆã€ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¾ã¨ã‚ã‚‹
                const totalViewTitle = viewTitle === 'äºˆç´„' ? 'å…¨äºˆç´„ãƒ•ã‚£ã‚®ãƒ¥ã‚¢' : 'å…¨æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢';
                groupedReservations[totalViewTitle] = reservationsToRender;
            } else {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
                reservationsToRender.forEach(r => {
                    let groupKey;
                    if (groupBy === 'releaseDateMonth') {
                        const date = r.releaseDate;
                        groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                    } else if (groupBy === 'manufacturer') {
                        groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼æœªå®š';
                    } else if (groupBy === 'shop') {
                        groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—æœªå®š';
                    } else if (groupBy === 'scale') {
                        groupKey = r.scale && r.scale.trim() !== '' ? 'ã‚¹ã‚±ãƒ¼ãƒ«ï¼š' + r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«æœªå®š';
                    }
                    
                    if (!groupedReservations[groupKey]) {
                        groupedReservations[groupKey] = [];
                    }
                    groupedReservations[groupKey].push(r);
                });
            }

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ã‚Šã®å ´åˆã¨åŒã˜ã§OK
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                // 'none'ã®å ´åˆã¯ã‚­ãƒ¼ãŒä¸€ã¤ãªã®ã§ã‚½ãƒ¼ãƒˆä¸è¦
                return a.localeCompare(b);
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚ã‚Šã®å ´åˆ
            sortedGroupKeys.forEach((groupKey) => {
                const reservationsInGroup = groupedReservations[groupKey];
                const count = reservationsInGroup.length;
                let displayKey = groupKey;
                
                if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                    const [year, month] = groupKey.split(' ')[0].split('-');
                    displayKey = `${year}å¹´${month}æœˆ ${groupKey.split(' ')[1]}`;
                }
                
                // ğŸ”½ ä¿®æ­£: 'none'ã®å ´åˆã€ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€Œ(å…¨...ä»¶)ã€ã‚’å‰Šé™¤ã—ã€ä»¶æ•°ã‚’æœ«å°¾ã«ç§»å‹•
                if (groupBy === 'none') {
                    // ã‚­ãƒ¼ã¯ã€Œå…¨æœªå®Œäº†ã‚¢ã‚¤ãƒ†ãƒ ã€ã¾ãŸã¯ã€Œå…¨æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã€
                    displayKey = groupKey;
                }

                // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-summary-item border border-fuchsia-400 rounded-xl shadow-sm hover:shadow-md transition duration-200';
                
                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼
                const header = document.createElement('div');
                // ğŸŒŸ åˆæœŸçŠ¶æ…‹ã¯é–‰ã˜ã‚‹ã®ã§ã€è§’ä¸¸ã‚’ã™ã¹ã¦ä»˜ã‘ã‚‹ 'rounded-xl'
                header.className = 'p-3 bg-fuchsia-100 dark:bg-fuchsia-800 rounded-xl font-bold text-gray-800 dark:text-white flex justify-between items-center cursor-pointer hover:bg-fuchsia-200 dark:hover:bg-fuchsia-700 transition duration-150';
                
                // ğŸŒŸ ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»¶æ•°ã¨ãƒˆã‚°ãƒ«ç”¨ã®ã‚·ã‚§ãƒ–ãƒ­ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
                header.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <span>${displayKey}</span>
                        <div class="flex items-center">
                            <span class="text-fuchsia-700 font-extrabold flex-shrink-0 mr-2 dark:text-fuchsia-300">${count} ä»¶</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition duration-200 transform summary-chevron"></i>
                        </div>
                    </div>
                `;
                groupContainer.appendChild(header);

                // ğŸŒŸ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ (åˆæœŸã¯éè¡¨ç¤º)
                const figureList = document.createElement('div');
                // ğŸ”½ åˆæœŸçŠ¶æ…‹ã§ã¯ hidden ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
                figureList.className = 'p-2 space-y-1 bg-white dark:bg-gray-700 rounded-b-xl hidden summary-content';
                
                reservationsInGroup.forEach(r => {
                    const scrollHandler = () => {
                        const targetEl = document.getElementById(`item-${r.id}`);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                            targetEl.classList.add('animate-pulse-once');
                            setTimeout(() => {
                                targetEl.classList.remove('animate-pulse-once');
                            }, 2000);
                        }
                    };
                    
                    const figureItem = document.createElement('p');
                    figureItem.className = 'text-xs text-gray-600 dark:text-gray-300 truncate px-2 py-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded cursor-pointer';
                    figureItem.textContent = r.name + (r.scale && r.scale.trim() !== '' ? ` (${r.scale})` : '');
                    // ğŸŒŸ å€‹åˆ¥ãƒ•ã‚£ã‚®ãƒ¥ã‚¢é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©²å½“ã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    figureItem.onclick = scrollHandler;
                    figureList.appendChild(figureItem);
                });

                groupContainer.appendChild(figureList);
                groupSummaryTargetEl.appendChild(groupContainer);
                
                // ğŸŒŸ ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«ã™ã‚‹å‡¦ç†ã«å¤‰æ›´
                const chevron = header.querySelector('.summary-chevron');
                header.onclick = () => {
                    figureList.classList.toggle('hidden');
                    
                    // ãƒªã‚¹ãƒˆã®è¡¨ç¤ºçŠ¶æ…‹ã«åˆã‚ã›ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã®è§’ä¸¸ã¨ã‚·ã‚§ãƒ–ãƒ­ãƒ³ã‚’èª¿æ•´
                    if (figureList.classList.contains('hidden')) {
                        // é–‰ã˜ã¦ã„ã‚‹çŠ¶æ…‹: ã™ã¹ã¦è§’ä¸¸ã«ã—ã€ã‚·ã‚§ãƒ–ãƒ­ãƒ³ã¯ä¸‹å‘ã
                        header.classList.add('rounded-xl');
                        header.classList.remove('rounded-t-xl');
                        chevron.classList.remove('rotate-180');
                    } else {
                        // é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹: ä¸‹éƒ¨ã‚’è§’ä¸¸ãªã—ã«ã—ã€ã‚·ã‚§ãƒ–ãƒ­ãƒ³ã¯ä¸Šå‘ã
                        header.classList.remove('rounded-xl');
                        header.classList.add('rounded-t-xl');
                        chevron.classList.add('rotate-180');
                    }
                };
            });
            // --- ğŸ”¼ ä¿®æ­£ã“ã“ã¾ã§ ğŸ”¼ ---

            lucide.createIcons();
        };

        /**
         * ğŸŒŸ æ±ç”¨çš„ãªäºˆç´„ãƒªã‚¹ãƒˆæç”»é–¢æ•°
         */
        const renderReservationList = (
            reservationsToRender, 
            listTargetEl, 
            noDataTargetEl, 
            groupBy, 
            viewTitle, 
            showEditAndDelete = true
        ) => {
            listTargetEl.innerHTML = '';
            
            if (reservationsToRender.length === 0) {
                noDataTargetEl.classList.remove('hidden');
                return;
            } else {
                noDataTargetEl.classList.add('hidden');
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨)
            let groupedReservations = {};
            if (groupBy === 'none') {
                groupedReservations['å…¨ã‚¢ã‚¤ãƒ†ãƒ '] = reservationsToRender;
            } else {
                reservationsToRender.forEach(r => {
                    let groupKey;
                    if (groupBy === 'releaseDateMonth') {
                        const date = r.releaseDate;
                        groupKey = date ? date.substring(0, 7) + ' ' + (viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'è³¼å…¥/å—å–') : 'æ—¥ä»˜æœªå®š';
                    } else if (groupBy === 'manufacturer') {
                        groupKey = r.manufacturer && r.manufacturer.trim() !== '' ? r.manufacturer : 'ãƒ¡ãƒ¼ã‚«ãƒ¼æœªå®š';
                    } else if (groupBy === 'shop') {
                        groupKey = r.shop && r.shop.trim() !== '' ? r.shop : 'åº—èˆ—æœªå®š';
                    } else if (groupBy === 'scale') {
                        groupKey = r.scale && r.scale.trim() !== '' ? 'ã‚¹ã‚±ãƒ¼ãƒ«ï¼š' + r.scale : 'ã‚¹ã‚±ãƒ¼ãƒ«æœªå®š';
                    }
                    
                    if (!groupedReservations[groupKey]) {
                        groupedReservations[groupKey] = [];
                    }
                    groupedReservations[groupKey].push(r);
                });
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ã§ã‚½ãƒ¼ãƒˆ (æ—¥ä»˜ã®å ´åˆã¯æ˜‡é †)
            const sortedGroupKeys = Object.keys(groupedReservations).sort((a, b) => {
                if (groupBy === 'releaseDateMonth') {
                    if (a.includes('æœªå®š')) return 1;
                    if (b.includes('æœªå®š')) return -1;
                    return a.localeCompare(b);
                }
                return a.localeCompare(b);
            });

            // ãƒªã‚¹ãƒˆæœ¬ä½“ã‚’æç”»
            sortedGroupKeys.forEach(groupKey => {
                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º
                if (groupBy !== 'none') {
                    const header = document.createElement('div');
                    // ğŸŒŸ ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‹ã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ãŸã‚ã®IDã‚’ä»˜ä¸
                    const safeId = `group-${viewTitle.replace(/[^a-zA-Z]/g, '')}-${groupKey.replace(/[^a-zA-Z0-9\-\_]/g, '')}`;
                    header.className = 'group-header dark:group-header';
                    header.id = safeId;
                    
                    let displayKey = groupKey;
                    if (groupBy === 'releaseDateMonth' && groupKey.includes(' ')) {
                        const [year, month] = groupKey.split(' ')[0].split('-');
                        displayKey = `${year}å¹´${month}æœˆ ${groupKey.split(' ')[1]}`;
                    }

                    // ğŸ”½ å¤‰æ›´: ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºã‹ã‚‰ã€Œã”ã¨ã€ã‚’å‰Šé™¤
                    header.innerHTML = `${displayKey} (${groupedReservations[groupKey].length} ä»¶)`;
                    listTargetEl.appendChild(header);
                }

                // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã®è¡¨ç¤º
                groupedReservations[groupKey].forEach(reservation => {
                    const imageUrl = reservation.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image';
                    const isCompleted = reservation.status === STATUS_COMPLETED || reservation.status === STATUS_CANCELLED;
                    const statusColorClass = STATUS_COLORS[reservation.status] || 'bg-gray-100 text-gray-800 border-gray-300';

                    const card = document.createElement('div');
                    const cardClass = `p-4 border border-gray-200 rounded-xl shadow-md bg-white transition duration-200 flex space-x-4 items-center ${viewTitle === 'äºˆç´„' && isCompleted ? 'opacity-70 bg-gray-50 dark:bg-gray-700' : 'hover:shadow-lg hover:border-fuchsia-300 dark:bg-gray-800 dark:border-gray-700 dark:hover:border-fuchsia-500'}`;
                    card.className = cardClass;
                    // ğŸŒŸ å€‹åˆ¥ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚«ãƒ¼ãƒ‰ã®IDã‚’ä»˜ä¸
                    card.id = `item-${reservation.id}`; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆID
                    
                    const actionButtons = showEditAndDelete ? `
                        <div class="flex space-x-2 flex-shrink-0">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 dark:text-indigo-400 dark:hover:bg-indigo-900 transition" data-id="${reservation.id}">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900 transition" data-id="${reservation.id}" data-name="${reservation.name}">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    ` : '';

                    card.innerHTML = `
                        <div class="figure-image-wrapper">
                            <img src="${imageUrl}" alt="${reservation.name}" class="figure-image">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white truncate">${reservation.name}</h3>
                                ${actionButtons}
                            </div>
                            <div class="text-sm grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-gray-600 dark:text-gray-300">
                                
                                <p class="font-medium flex items-center">
                                    <i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-indigo-500"></i> 
                                    ${viewTitle === 'äºˆç´„' ? 'ç™ºå£²äºˆå®š' : 'å—å–æ—¥'}: 
                                    <span class="text-gray-900 dark:text-white font-semibold ml-1">${reservation.releaseDate || 'N/A'}</span>
                                </p>
                                <p class="flex items-center">
                                    <i data-lucide="tag" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                    <span class="px-3 py-0.5 text-xs font-bold rounded-full border ${statusColorClass} shadow-sm">${reservation.status}</span>
                                </p>

                                <p class="flex items-center font-bold text-base text-fuchsia-700 dark:text-fuchsia-400">
                                    <i data-lucide="circle-yen" class="w-4 h-4 mr-2 text-fuchsia-700 dark:text-fuchsia-400"></i> 
                                    ä¾¡æ ¼: ${reservation.price ? reservation.price.toLocaleString() : 0} å††
                                </p>
                                <p class="flex items-center">
                                    <i data-lucide="ruler" class="w-4 h-4 mr-2 text-gray-500"></i> 
                                    ã‚¹ã‚±ãƒ¼ãƒ«ï¼š${reservation.scale || 'N/A'}
                                </p>
                                <p class="flex items-center">
                                    <i data-lucide="factory" class="w-4 h-4 mr-2 text-gray-500"></i> 
                                    ãƒ¡ãƒ¼ã‚«ãƒ¼: ${reservation.manufacturer || 'N/A'}
                                </p>
                                <p class="flex items-center">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-2 text-gray-500"></i> 
                                    äºˆç´„æ—¥: ${reservation.reservationDate || 'N/A'}
                                </p>
                                <p class="flex items-center">
                                    <i data-lucide="store" class="w-4 h-4 mr-2 text-gray-500"></i> 
                                    åº—èˆ—: ${reservation.shop || 'N/A'}
                                </p>
                                <p></p>
                            </div>
                        </div>
                    `;
                    listTargetEl.appendChild(card);
                });
            });

            // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            addEventListeners();
            lucide.createIcons();
        };

        /**
         * ğŸŒŸ ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’äºˆç´„ãƒªã‚¹ãƒˆã¨æ‰€æŒãƒªã‚¹ãƒˆã«æŒ¯ã‚Šåˆ†ã‘ã€æç”»ï¼‰
         */
        const renderAllViews = () => {
            // äºˆç´„ãƒªã‚¹ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–è¨­å®šã‚’æ›´æ–°
            const groupBy = groupBySelect.value;
            // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãƒªã‚¹ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–è¨­å®šã‚’æ›´æ–°
            const groupByOwned = groupBySelectOwned ? groupBySelectOwned.value : 'none';

            // 1. çµ±è¨ˆæƒ…å ±ã®æ›´æ–° (ã“ã“ã§ã¯æ›´æ–°ã—ãªã„ã€‚switchTab/åˆæœŸåŒ–æ™‚ã«è¡Œã†)
            // updateStats();
            
            // 2. ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
            const pendingReservations = reservations.filter(r => r.status !== STATUS_COMPLETED && r.status !== STATUS_CANCELLED);
            const ownedReservations = reservations.filter(r => r.status === STATUS_COMPLETED);

            // 3. äºˆç´„ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('reservations', groupBy); 
            renderGroupSummary(
                pendingReservations, 
                groupSummaryListEl, 
                groupBy, 
                'äºˆç´„'
            );
            renderReservationList(
                pendingReservations, 
                reservationListEl, 
                noDataMessage, 
                groupBy, 
                'äºˆç´„', 
                true
            );
            
            // 4. æ‰€æŒãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            // ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            updateSummaryTitle('owned', groupByOwned);
            renderGroupSummary(
                ownedReservations, 
                groupSummaryListOwnedEl, 
                // ğŸ”½ äºˆç´„ã‚·ãƒ¼ãƒˆã¨åŒæ§˜ã«ã€groupByOwnedã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
                groupByOwned, 
                'æ‰€æŒ'
            );
            renderReservationList(
                ownedReservations, 
                ownedListEl, 
                noOwnedDataMessage, 
                // ğŸ”½ äºˆç´„ã‚·ãƒ¼ãƒˆã¨åŒæ§˜ã«ã€groupByOwnedã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
                groupByOwned, 
                'æ‰€æŒ', 
                true // ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º (ä¸»ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ç”¨)
            );

            // 5. èª­ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«
            loadingIndicator.classList.add('hidden');
            loadingIndicatorOwned.classList.add('hidden');

            // 6. ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®å†…å®¹ã‚’è¡¨ç¤º/éè¡¨ç¤ºã« (onSnapshotå¾Œã«å‘¼ã°ã‚Œã‚‹ãŸã‚)
            switchTab(currentView, false);
        };

        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š (renderAllViewsã‚’å‘¼ã¶ã‚ˆã†ã«å¤‰æ›´)
        const setupFirestoreListener = () => {
            const q = query(collection(db, COLLECTION_NAME));

            // onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ç›£è¦–
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                loadingIndicator.classList.remove('hidden');
                loadingIndicatorOwned.classList.remove('hidden');

                const newReservations = [];
                querySnapshot.forEach((doc) => {
                    newReservations.push({ id: doc.id, ...doc.data() });
                });
                reservations = newReservations; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªreservationsã‚’æ›´æ–°

                renderAllViews(); // ğŸŒŸ å…¨ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

                authInfoEl.innerHTML = '<i data-lucide="cloud" class="w-5 h-5 mr-3 inline-block"></i>ã€æ¥ç¶šæ¸ˆã¿ã€‘Firebase FirestoreçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800', 'bg-red-100', 'border-red-500', 'text-red-800');
                authInfoEl.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                
                lucide.createIcons();
            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                authInfoEl.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5 mr-3 inline-block"></i>ã‚¨ãƒ©ãƒ¼: Firestoreãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è¨­å®šæƒ…å ±ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500');
                authInfoEl.classList.add('bg-red-100', 'border-red-500');
            });
        };

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (å¤‰æ›´ãªã—)
        const openModal = (id = null) => {
        // ... (çœç•¥: openModal ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            form.reset();
            document.getElementById('doc-id').value = id || '';
            modalTitle.textContent = id ? 'äºˆç´„æƒ…å ±ã‚’ç·¨é›†' : 'æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ';

            if (id) {
                const reservation = reservations.find(r => r.id === id);
                if (reservation) {
                    document.getElementById('name').value = reservation.name || '';
                    document.getElementById('imageUrl').value = reservation.imageUrl || '';
                    document.getElementById('manufacturer').value = reservation.manufacturer || '';
                    document.getElementById('scale').value = reservation.scale || '';
                    document.getElementById('reservationDate').value = reservation.reservationDate || '';
                    document.getElementById('releaseDate').value = reservation.releaseDate || '';
                    document.getElementById('shop').value = reservation.shop || '';
                    document.getElementById('price').value = reservation.price || 0;
                    document.getElementById('status').value = reservation.status || 'äºˆç´„æ¸ˆã¿';
                    document.getElementById('orderNumber').value = reservation.orderNumber || '';
                    document.getElementById('notes').value = reservation.notes || '';
                }
            }
            modal.classList.remove('hidden');
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ (å¤‰æ›´ãªã—)
        const closeModal = () => {
        // ... (çœç•¥: closeModal ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            modal.classList.add('hidden');
        };

        // äºˆç´„ã®ä¿å­˜ï¼ˆæ–°è¦ã¾ãŸã¯ç·¨é›†ï¼‰ (å¤‰æ›´ãªã—)
        const saveReservation = async (e) => {
        // ... (çœç•¥: saveReservation ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');

            const docId = document.getElementById('doc-id').value;
            
            const name = document.getElementById('name').value.trim();
            const imageUrl = document.getElementById('imageUrl').value.trim();
            const manufacturer = document.getElementById('manufacturer').value.trim();
            const scale = document.getElementById('scale').value.trim();
            const reservationDate = document.getElementById('reservationDate').value;
            const releaseDate = document.getElementById('releaseDate').value;
            const shop = document.getElementById('shop').value.trim();
            const price = parseInt(document.getElementById('price').value) || 0;
            const status = document.getElementById('status').value;
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const notes = document.getElementById('notes').value.trim();

            const data = {
                name,
                imageUrl,
                manufacturer,
                scale,
                reservationDate,
                releaseDate,
                shop,
                price,
                status,
                orderNumber,
                notes,
                updatedAt: serverTimestamp()
            };

            try {
                if (docId) {
                    // ç·¨é›†
                    await setDoc(doc(db, COLLECTION_NAME, docId), data, { merge: true });
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:", docId);
                } else {
                    // æ–°è¦ä½œæˆ
                    await addDoc(collection(db, COLLECTION_NAME), {
                        ...data,
                        createdAt: serverTimestamp()
                    });
                    console.log("æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
                }
                closeModal();
            } catch (error) {
                console.error("äºˆç´„ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };

        // äºˆç´„ã®å‰Šé™¤ (å¤‰æ›´ãªã—)
        const deleteReservation = async () => {
        // ... (çœç•¥: deleteReservation ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            if (!docIdToDelete) return;
            loadingIndicator.classList.remove('hidden');
            loadingIndicatorOwned.classList.remove('hidden');
            
            try {
                await deleteDoc(doc(db, COLLECTION_NAME, docIdToDelete));
                console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ:", docIdToDelete);
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            } catch (error) {
                console.error("äºˆç´„ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingIndicatorOwned.classList.add('hidden');
            }
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ  (ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«å†è¿½åŠ )
        const addEventListeners = () => {
        // ... (çœç•¥: addEventListeners ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            // ç·¨é›†ãƒœã‚¿ãƒ³
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    openModal(e.currentTarget.dataset.id);
                };
            });
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    docIdToDelete = e.currentTarget.dataset.id;
                    const itemName = e.currentTarget.dataset.name || 'ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ';
                    deleteItemNameEl.textContent = itemName;
                    deleteModal.classList.remove('hidden');
                };
            });
            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œã¯DOMãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨­å®š
            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼å†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯ renderGroupSummary å†…ã§å‡¦ç†ã•ã‚Œã¾ã™
        };

        /**
         * ğŸŒŸ ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•° (å¤‰æ›´: updateStats(view) ã®å‘¼ã³å‡ºã—ã‚’è¿½åŠ )
         * @param {string} view - 'reservations' or 'owned'
         * @param {boolean} updateHistory - trueã®å ´åˆã€URLã‚’æ›´æ–°
         */
        const switchTab = (view, updateHistory = true) => {
            currentView = view;

            // 1. Tab Styling
            const activeClass = 'border-fuchsia-500 text-fuchsia-600 dark:text-fuchsia-400';
            const inactiveClass = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500';

            if (view === 'reservations') {
                tabReservationsBtn.className = tabReservationsBtn.className.replace(inactiveClass, activeClass);
                tabOwnedBtn.className = tabOwnedBtn.className.replace(activeClass, inactiveClass);
            } else {
                tabReservationsBtn.className = tabReservationsBtn.className.replace(activeClass, inactiveClass);
                tabOwnedBtn.className = tabOwnedBtn.className.replace(inactiveClass, activeClass);
            }

            // 2. Page Visibility
            pageReservationsEl.classList.toggle('hidden', view !== 'reservations');
            pageOwnedEl.classList.toggle('hidden', view !== 'owned');
            
            // 3. History Update (ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³å¯¾å¿œ)
            if (updateHistory) {
                history.pushState({ view: view }, '', `#${view}`);
            }
            
            // 4. çµ±è¨ˆæƒ…å ±ã®æ›´æ–° (ğŸŒŸ è¿½åŠ )
            updateStats(view);

            // 5. lucideã‚¢ã‚¤ã‚³ãƒ³ã®å†æç”»
            lucide.createIcons();
        };

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰é–¢é€£ã®é–¢æ•°
        const loadTheme = () => {
        // ... (çœç•¥: loadTheme ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        const toggleDarkMode = () => {
        // ... (çœç•¥: toggleDarkMode ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        };


        // Firebaseã®åˆæœŸåŒ–ã¨ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const initAuthAndDb = async () => {
        // ... (çœç•¥: initAuthAndDb ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            // Firebaseè¨­å®šãŒç©ºã§ãªã„ã‹ç¢ºèª
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                if (authInfoEl) {
                    authInfoEl.innerHTML = 
                        '<i data-lucide="alert-circle" class="w-5 h-5 mr-3 inline-block"></i>ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šæƒ…å ±ãŒæœªå…¥åŠ›ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰å†…ã®`firebaseConfig`ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚';
                    authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                    authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                    loadingIndicator.classList.add('hidden');
                    return;
                }
            }

            try {
                // FirebaseåˆæœŸåŒ–
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // åŒ¿åèªè¨¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆç°¡æ˜“çš„ãªèªè¨¼ï¼‰
                await signInAnonymously(auth);
                
                // Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupFirestoreListener();

            } catch (error) {
                console.error("Firebase Authã¾ãŸã¯Firestoreã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", error);
                authInfoEl.innerHTML = 
                    '<i data-lucide="alert-circle" class="w-5 h-5 mr-3 inline-block"></i>ã‚¨ãƒ©ãƒ¼: FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šæƒ…å ±ï¼ˆfirebaseConfigï¼‰ã¾ãŸã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                loadingIndicator.classList.add('hidden');
            }
        };

        // ã‚¢ãƒ—ãƒªã®é–‹å§‹ (ä¿®æ­£: ãƒ†ãƒ¼ãƒãƒ­ãƒ¼ãƒ‰ã¨ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã®è¨­å®šã‚’è¿½åŠ )
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ†ãƒ¼ãƒã‚’æœ€åˆã«ãƒ­ãƒ¼ãƒ‰
            loadTheme(); 
            
            lucide.createIcons();
            initAuthAndDb();
            
            // URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰åˆæœŸãƒ“ãƒ¥ãƒ¼ã‚’è¨­å®š
            const hash = window.location.hash.substring(1);
            if (hash === 'owned') {
                currentView = 'owned';
            } else {
                currentView = 'reservations';
            }
            // switchTab(currentView, false); // renderAllViewsã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã®ã§å‰Šé™¤

            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œæˆ»ã‚‹/é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            window.onpopstate = (event) => {
                const view = event.state && event.state.view ? event.state.view : (window.location.hash.substring(1) || 'reservations');
                switchTab(view, false);
            };

            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã€å‰Šé™¤ç¢ºèªãªã©ã®å›ºå®šãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            openModalBtn.onclick = () => openModal();
            closeModalBtn.onclick = closeModal;
            modalCloseIcon.onclick = closeModal;
            form.onsubmit = saveReservation;
            cancelDeleteBtn.onclick = () => {
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            };
            confirmDeleteBtn.onclick = deleteReservation;
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const toggleBtn = document.getElementById('toggle-dark-mode');
            if (toggleBtn) {
                toggleBtn.onclick = toggleDarkMode;
            }
            
            // ğŸŒŸ ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            tabReservationsBtn.onclick = () => switchTab('reservations');
            tabOwnedBtn.onclick = () => switchTab('owned');
            
            // äºˆç´„ãƒšãƒ¼ã‚¸ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            groupBySelect.onchange = () => {
                if (currentView === 'reservations') {
                    renderAllViews();
                }
            };
            
            // ğŸ”½ æ‰€æŒãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚·ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (groupBySelectOwned) {
                groupBySelectOwned.onchange = () => {
                    if (currentView === 'owned') {
                        renderAllViews();
                    }
                };
            }
        });
    </script>
</body>
</html>