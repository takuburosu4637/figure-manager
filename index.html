<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢äºˆç´„ç®¡ç†ã‚¢ãƒ—ãƒª (ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .reservation-list {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
            <i data-lucide="package" class="w-7 h-7 mr-2 text-indigo-600"></i>
            ãƒ•ã‚£ã‚®ãƒ¥ã‚¢äºˆç´„ç®¡ç† (ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ)
        </h1>

        <!-- Firebaseæ¥ç¶šæƒ…å ±ã‚¨ãƒªã‚¢ -->
        <div id="auth-info-firebase" class="mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg shadow-md text-sm text-yellow-800 font-semibold">
            <i data-lucide="cloud-off" class="w-4 h-4 mr-2 inline-block"></i>
            ã€æœªæ¥ç¶šã€‘`firebaseConfig`ã‚’è¨­å®šã—ã¦ã€Firebaseã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚
        </div>

        <!-- çµ±è¨ˆæƒ…å ±ãƒ‘ãƒãƒ« -->
        <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- çµ±è¨ˆæƒ…å ±ã¯JSã§å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- äºˆç´„è¿½åŠ ãƒœã‚¿ãƒ³ -->
        <button id="open-modal-btn" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 mb-6 flex items-center justify-center">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
            æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ 
        </button>

        <!-- äºˆç´„ä¸€è¦§ -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">äºˆç´„ãƒªã‚¹ãƒˆ</h2>
            
            <div id="loading-indicator" class="text-center py-10 text-gray-500 hidden">
                <i data-lucide="loader-circle" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...
            </div>

            <div id="reservation-list" class="reservation-list space-y-4">
                <!-- äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ ã¯JSã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <div id="no-data-message" class="text-center py-10 text-gray-500 hidden">
                <i data-lucide="info" class="w-6 h-6 mx-auto mb-2"></i>
                ç¾åœ¨ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ (äºˆç´„è¿½åŠ /ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ) -->
    <div id="reservation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 relative">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ </h2>
            
            <form id="reservation-form" class="space-y-4">
                <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ for document ID -->
                <input type="hidden" id="doc-id">

                <!-- 1. ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å (å¿…é ˆ) -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å <span class="text-red-500">*</span></label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- 2. ãƒ¡ãƒ¼ã‚«ãƒ¼å -->
                <div>
                    <label for="manufacturer" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ã‚«ãƒ¼å/ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
                    <input type="text" id="manufacturer" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 3. äºˆç´„æ—¥ & ç™ºå£²äºˆå®šæ—¥ (æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reservationDate" class="block text-sm font-medium text-gray-700">äºˆç´„æ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="reservationDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="releaseDate" class="block text-sm font-medium text-gray-700">ç™ºå£²/å¼•æ¸¡äºˆå®šæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="releaseDate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- 4. è³¼å…¥åº—èˆ—/ã‚µã‚¤ãƒˆ -->
                <div>
                    <label for="shop" class="block text-sm font-medium text-gray-700">è³¼å…¥åº—èˆ—/äºˆç´„ã‚µã‚¤ãƒˆ</label>
                    <input type="text" id="shop" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 5. ä¾¡æ ¼ (æ•°å€¤) -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">ä¾¡æ ¼ (å††)</label>
                    <input type="number" id="price" min="0" value="0" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 6. äºˆç´„çŠ¶æ³ (ã‚»ãƒ¬ã‚¯ãƒˆ) -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">äºˆç´„çŠ¶æ³ <span class="text-red-500">*</span></label>
                    <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none">
                        <option value="äºˆç´„æ¸ˆã¿">äºˆç´„æ¸ˆã¿</option>
                        <option value="æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰">æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰</option>
                        <option value="ç™ºé€é€£çµ¡å¾…ã¡">ç™ºé€é€£çµ¡å¾…ã¡</option>
                        <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        <option value="å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†">å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†</option>
                    </select>
                </div>

                <!-- 7. æ³¨æ–‡ç•ªå·/å‚™è€ƒæ¬„ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="orderNumber" class="block text-sm font-medium text-gray-700">æ³¨æ–‡ç•ªå·/äºˆç´„ç•ªå·</label>
                        <input type="text" id="orderNumber" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">å‚™è€ƒæ¬„</label>
                        <input type="text" id="notes" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="close-modal-btn" class="px-6 py-2 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-xl shadow-md hover:bg-green-700 transition duration-150">ä¿å­˜</button>
                </div>
            </form>
            <button id="modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="delete-modal" class="fixed inset-0 bg-red-900 bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold text-red-600 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                å‰Šé™¤ã®ç¢ºèª
            </h3>
            <p class="text-gray-700">æœ¬å½“ã«ã“ã®äºˆç´„æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-xl shadow-md hover:bg-red-700 transition duration-150">å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰
        setLogLevel('Debug');
        
        // =========================================================
        // ğŸš¨ ã€é‡è¦ã€‘ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // =========================================================
    	const firebaseConfig = {
  		apiKey: "AIzaSyD9jmIafM4JjpJyv65WjFWlbV_n9dssUt4",
  		authDomain: "figure-manager-app.firebaseapp.com",
  		projectId: "figure-manager-app",
  		storageBucket: "figure-manager-app.firebasestorage.app",
  		messagingSenderId: "487492839040",
  		appId: "1:487492839040:web:a43419d861335f259da865",
  		measurementId: "G-19FTK3XTW4"
	};
        // =========================================================
        // ğŸš¨ ã“ã“ã‹ã‚‰ä¸‹ã¯ç·¨é›†ã—ãªã„ã§ãã ã•ã„
        // =========================================================

        let db, auth;
        let reservations = [];
        const COLLECTION_NAME = 'figure_reservations_data'; 

        // DOMè¦ç´ ã®å–å¾—
        const reservationListEl = document.getElementById('reservation-list');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');
        const modal = document.getElementById('reservation-modal');
        const form = document.getElementById('reservation-form');
        const modalTitle = document.getElementById('modal-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');
        const statsEl = document.getElementById('stats');
        const authInfoEl = document.getElementById('auth-info-firebase');
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let docIdToDelete = null;

        // äºˆç´„çŠ¶æ³ã®ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
        const STATUS_COLORS = {
            'äºˆç´„æ¸ˆã¿': 'bg-blue-100 text-blue-800',
            'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰': 'bg-yellow-100 text-yellow-800',
            'ç™ºé€é€£çµ¡å¾…ã¡': 'bg-indigo-100 text-indigo-800',
            'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 'bg-gray-100 text-gray-500',
            'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†': 'bg-green-100 text-green-800'
        };

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        const updateStats = () => {
            if (reservations.length === 0) {
                statsEl.innerHTML = '';
                return;
            }

            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            let totalReserved = 0;
            let upcomingPaymentTotal = 0;
            let pendingReservations = 0;

            reservations.forEach(r => {
                const price = r.price || 0;
                const releaseDate = r.releaseDate ? new Date(r.releaseDate) : null;
                const status = r.status;

                // æ”¯æ‰•ã„äºˆå®šç·é¡ã®è¨ˆç®— (å—ã‘å–ã‚Šæ¸ˆã¿ä»¥å¤–)
                if (status !== 'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†' && status !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') {
                    totalReserved += price;
                }

                // ä»Šæœˆãƒ»æ¥æœˆç™ºå£²äºˆå®šã®æ”¯æ‰•ã„åˆè¨ˆ (ã¾ã å—ã‘å–ã£ã¦ãªã„ã‚‚ã®)
                if (releaseDate && status !== 'å—ã‘å–ã‚Šæ¸ˆã¿/å®Œäº†' && status !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') {
                    const releaseMonth = releaseDate.getMonth();
                    const releaseYear = releaseDate.getFullYear();
                    
                    const nextMonthDate = new Date();
                    nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                    const nextMonth = nextMonthDate.getMonth();
                    const nextMonthYear = nextMonthDate.getFullYear();

                    const isThisMonth = releaseYear === thisYear && releaseMonth === thisMonth;
                    const isNextMonth = releaseYear === nextMonthYear && releaseMonth === nextMonth;
                    
                    if (isThisMonth || isNextMonth) {
                        upcomingPaymentTotal += price;
                    }
                }

                // æœªå®Œäº†ã®äºˆç´„ä»¶æ•°
                if (status === 'äºˆç´„æ¸ˆã¿' || status === 'æ”¯æ‰•ã„æ¸ˆã¿ï¼ˆæœªç™ºé€ï¼‰' || status === 'ç™ºé€é€£çµ¡å¾…ã¡') {
                    pendingReservations++;
                }
            });

            const totalReservations = reservations.length;
            
            const formatCurrency = (amount) => {
                return amount.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' });
            };

            statsEl.innerHTML = `
                ${createStatCard('äºˆç´„ç·ä»¶æ•°', totalReservations, 'list-ordered', 'text-indigo-600')}
                ${createStatCard('æœªå®Œäº†ä»¶æ•°', pendingReservations, 'package-search', 'text-red-600')}
                ${createStatCard('æ”¯æ‰•ã„äºˆå®šç·é¡ (æœªå®Œäº†)', formatCurrency(totalReserved), 'wallet', 'text-purple-600')}
                ${createStatCard('ä»Šæœˆ/æ¥æœˆæ”¯æ‰•äºˆå®š', formatCurrency(upcomingPaymentTotal), 'calendar-clock', 'text-amber-600')}
            `;
            // Lucideã‚¢ã‚¤ã‚³ãƒ³ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            lucide.createIcons();
        };

        const createStatCard = (title, value, iconName, iconColor) => {
            return `
                <div class="bg-white p-4 rounded-xl shadow flex items-center justify-between transition hover:shadow-lg">
                    <div>
                        <p class="text-sm font-medium text-gray-500">${title}</p>
                        <p class="text-2xl font-bold text-gray-900">${value}</p>
                    </div>
                    <div class="${iconColor} bg-gray-50 p-2 rounded-full">
                        <i data-lucide="${iconName}" class="w-6 h-6"></i>
                    </div>
                </div>
            `;
        };

        // äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const renderReservations = (newReservations) => {
            // ç™ºå£²äºˆå®šæ—¥(releaseDate)ã§æ˜‡é †ã‚½ãƒ¼ãƒˆ
            newReservations.sort((a, b) => {
                return new Date(a.releaseDate) - new Date(b.releaseDate);
            });
            reservations = newReservations; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«åæ˜ 
            
            reservationListEl.innerHTML = '';
            
            if (reservations.length === 0) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }

            reservations.forEach(reservation => {
                const statusColorClass = STATUS_COLORS[reservation.status] || 'bg-gray-200 text-gray-600';
                
                const card = document.createElement('div');
                card.className = "p-4 border border-gray-200 rounded-lg shadow-sm bg-white hover:bg-gray-50 transition duration-150";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-800">${reservation.name}</h3>
                        <div class="flex space-x-2">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 transition" data-id="${reservation.id}">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition" data-id="${reservation.id}">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="text-sm space-y-1 text-gray-600">
                        <p class="font-medium flex items-center">
                            <i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-green-500"></i>
                            <span class="text-gray-900 font-semibold">${reservation.releaseDate}</span> ç™ºå£²äºˆå®š 
                            <span class="ml-4 px-2 py-0.5 text-xs font-medium rounded-full ${statusColorClass}">${reservation.status}</span>
                        </p>
                        <p class="flex items-center">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2 text-gray-500"></i>
                            äºˆç´„æ—¥: ${reservation.reservationDate}
                        </p>
                        <p class="flex items-center">
                            <i data-lucide="factory" class="w-4 h-4 mr-2 text-gray-500"></i>
                            ãƒ¡ãƒ¼ã‚«ãƒ¼: ${reservation.manufacturer || 'N/A'}
                        </p>
                        <p class="flex items-center">
                            <i data-lucide="store" class="w-4 h-4 mr-2 text-gray-500"></i>
                            åº—èˆ—: ${reservation.shop || 'N/A'}
                        </p>
                        <p class="flex items-center font-bold text-base text-indigo-700">
                            <!-- ğŸš¨ ä¿®æ­£ç®‡æ‰€: yen ã‚’ circle-yen ã«å¤‰æ›´ -->
                            <i data-lucide="circle-yen" class="w-4 h-4 mr-2 text-indigo-700"></i>
                            ä¾¡æ ¼: ${reservation.price ? reservation.price.toLocaleString() : 0} å††
                        </p>
                        ${reservation.orderNumber ? `<p class="flex items-center"><i data-lucide="hash" class="w-4 h-4 mr-2 text-gray-500"></i>æ³¨æ–‡ç•ªå·: ${reservation.orderNumber}</p>` : ''}
                        ${reservation.notes ? `<p class="flex items-center"><i data-lucide="book-open" class="w-4 h-4 mr-2 text-gray-500"></i>å‚™è€ƒ: ${reservation.notes}</p>` : ''}
                    </div>
                `;
                reservationListEl.appendChild(card);
            });
            // Lucideã‚¢ã‚¤ã‚³ãƒ³ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            lucide.createIcons();
            addEventListeners();
            updateStats();
        };

        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const setupFirestoreListener = () => {
            const q = query(collection(db, COLLECTION_NAME));
            
            // onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ç›£è¦–
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                loadingIndicator.classList.remove('hidden');
                const newReservations = [];
                querySnapshot.forEach((doc) => {
                    newReservations.push({ id: doc.id, ...doc.data() });
                });
                renderReservations(newReservations);
                loadingIndicator.classList.add('hidden');

                authInfoEl.textContent = 'ã€æ¥ç¶šæ¸ˆã¿ã€‘Firebase FirestoreçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ã„ã¾ã™ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                lucide.createIcons();

            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                authInfoEl.textContent = 'ã‚¨ãƒ©ãƒ¼: Firestoreãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è¨­å®šæƒ…å ±ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500');
                authInfoEl.classList.add('bg-red-100', 'border-red-500');
            });

            // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ã¨ãã«ãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢ã™ã‚‹å ´åˆã¯ã“ã“ã§
            // window.onbeforeunload = unsubscribe;
        };


        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const openModal = (id = null) => {
            form.reset();
            document.getElementById('doc-id').value = id || '';
            modalTitle.textContent = id ? 'äºˆç´„æƒ…å ±ã‚’ç·¨é›†' : 'æ–°ã—ã„äºˆç´„ã‚’è¿½åŠ ';

            if (id) {
                const reservation = reservations.find(r => r.id === id);
                if (reservation) {
                    document.getElementById('name').value = reservation.name || '';
                    document.getElementById('manufacturer').value = reservation.manufacturer || '';
                    document.getElementById('reservationDate').value = reservation.reservationDate || '';
                    document.getElementById('releaseDate').value = reservation.releaseDate || '';
                    document.getElementById('shop').value = reservation.shop || '';
                    document.getElementById('price').value = reservation.price || 0;
                    document.getElementById('status').value = reservation.status || 'äºˆç´„æ¸ˆã¿';
                    document.getElementById('orderNumber').value = reservation.orderNumber || '';
                    document.getElementById('notes').value = reservation.notes || '';
                }
            }
            modal.classList.remove('hidden');
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const closeModal = () => {
            modal.classList.add('hidden');
        };

        // äºˆç´„ã®ä¿å­˜ï¼ˆæ–°è¦ã¾ãŸã¯ç·¨é›†ï¼‰
        const saveReservation = async (e) => {
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');

            const docId = document.getElementById('doc-id').value;
            const name = document.getElementById('name').value.trim();
            const manufacturer = document.getElementById('manufacturer').value.trim();
            const reservationDate = document.getElementById('reservationDate').value;
            const releaseDate = document.getElementById('releaseDate').value;
            const shop = document.getElementById('shop').value.trim();
            const price = parseInt(document.getElementById('price').value, 10) || 0;
            const status = document.getElementById('status').value;
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (!name || !reservationDate || !releaseDate || !status) {
                console.error('å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                loadingIndicator.classList.add('hidden');
                return;
            }

            const reservationData = {
                name,
                manufacturer,
                reservationDate,
                releaseDate,
                shop,
                price,
                status,
                orderNumber,
                notes,
                updatedAt: serverTimestamp()
            };


            try {
                if (docId) {
                    // ç·¨é›†ï¼ˆæ›´æ–°ï¼‰
                    const docRef = doc(db, COLLECTION_NAME, docId);
                    await setDoc(docRef, reservationData, { merge: true });
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:", docId);
                } else {
                    // æ–°è¦è¿½åŠ 
                    await addDoc(collection(db, COLLECTION_NAME), {
                        ...reservationData,
                        createdAt: serverTimestamp()
                    });
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
                }
            } catch (error) {
                console.error("äºˆç´„ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                closeModal();
            }
        };

        // äºˆç´„ã®å‰Šé™¤
        const deleteReservation = async () => {
            if (!docIdToDelete) return;

            loadingIndicator.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, COLLECTION_NAME, docIdToDelete));
                console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ:", docIdToDelete);
                
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            } catch (error) {
                console.error("äºˆç´„ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
        const addEventListeners = () => {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            openModalBtn.onclick = () => openModal();
            closeModalBtn.onclick = closeModal;
            modalCloseIcon.onclick = closeModal;

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            form.onsubmit = saveReservation;

            // ç·¨é›†ãƒœã‚¿ãƒ³
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    openModal(e.currentTarget.dataset.id);
                };
            });

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    docIdToDelete = e.currentTarget.dataset.id;
                    deleteModal.classList.remove('hidden');
                };
            });

            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
            cancelDeleteBtn.onclick = () => {
                deleteModal.classList.add('hidden');
                docIdToDelete = null;
            };
            confirmDeleteBtn.onclick = deleteReservation;
        };

        // Firebaseã®åˆæœŸåŒ–ã¨åŒ¿åèªè¨¼
        const initAuthAndDb = async () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                authInfoEl.textContent = 'ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šæƒ…å ±ãŒæœªå…¥åŠ›ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰å†…ã®`firebaseConfig`ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                // FirebaseåˆæœŸåŒ–
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // åŒ¿åèªè¨¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆç°¡æ˜“çš„ãªèªè¨¼ï¼‰
                await signInAnonymously(auth);
                
                // Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupFirestoreListener();

            } catch (error) {
                console.error("Firebase Authã¾ãŸã¯Firestoreã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", error);
                authInfoEl.textContent = 
                    'ã‚¨ãƒ©ãƒ¼: FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šæƒ…å ±ï¼ˆfirebaseConfigï¼‰ã¾ãŸã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                authInfoEl.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                authInfoEl.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                loadingIndicator.classList.add('hidden');
            }
        };

        // ã‚¢ãƒ—ãƒªã®é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initAuthAndDb();
            addEventListeners();
        });

    </script>
</body>
</html>
